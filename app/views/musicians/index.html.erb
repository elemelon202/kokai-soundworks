<div class="container musicians-index-container">
  <div class="index-heading m-3 mt-5">
    <h1>Musicians</h1>
    <p>Future artists</p>

    <%# DISCOVER SHORTS CTA %>
    <div style="margin-top: 16px;">
      <%= link_to discover_shorts_path, style: "display: inline-flex; align-items: center; gap: 12px; padding: 12px 20px; background: linear-gradient(135deg, #E936AD 0%, #7B2D8E 50%, #E936AD 100%); background-size: 200% 200%; color: #fff; border-radius: 12px; text-decoration: none; box-shadow: 0 4px 16px rgba(233, 54, 173, 0.4); transition: all 0.3s ease; animation: gradient-shift 3s ease infinite;",
          onmouseover: "this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 6px 24px rgba(233, 54, 173, 0.5)';",
          onmouseout: "this.style.transform=''; this.style.boxShadow='0 4px 16px rgba(233, 54, 173, 0.4)';" do %>
        <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
          <i class="fa-solid fa-play" style="font-size: 1rem; margin-left: 2px;"></i>
        </div>
        <div>
          <span style="font-size: 1rem; font-weight: 600; display: block;">Discover Shorts</span>
          <span style="font-size: 0.75rem; opacity: 0.9;">The fastest way to discover talent!</span>
        </div>
        <i class="fa-solid fa-arrow-right" style="font-size: 1rem;"></i>
      <% end %>
    </div>
  </div>

  <style>
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
  <%= form_with url: musicians_path, method: :get, data: { turbo_frame: "musicians_list" }, class: "filters-form" do %>
    <!-- Search Field -->
    <div class="mt-5 mb-5 d-flex gap-2 align-items-center">
      <%= text_field_tag :query, params[:query], placeholder: "Search...", class: "form-control", data: { action: "input->auto-submit#submit" } %>
      <%= link_to "Clear Filters", musicians_path, class: "btn btn-outline-secondary" %>
      <!-- Instruments Dropdown -->
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Instruments
        </button>
        <div class="dropdown-menu p-3" style="min-width: 200px;" data-controller="auto-submit">
          <% Musician.where.not(instrument: [nil, '']).distinct.order(:instrument).pluck(:instrument).each do |instrument| %>
            <div class="form-check">
              <%= check_box_tag "instrument[]", instrument, params[:instrument]&.include?(instrument), id: "instrument_#{instrument.parameterize}", class: "form-check-input", data: { action: "change->auto-submit#submit" } %>
              <%= label_tag "instrument_#{instrument.parameterize}", instrument, class: "form-check-label" %>
            </div>
          <% end %>
        </div>
      </div>
      <!-- Locations Dropdown -->
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Locations
        </button>
        <div class="dropdown-menu p-3" style="min-width: 200px;" data-controller="auto-submit">
          <% Musician.where.not(location: [nil, '']).distinct.order(:location).pluck(:location).each do |location| %>
            <div class="form-check">
              <%= check_box_tag "location[]", location, params[:location]&.include?(location), id: "location_#{location.parameterize}", class: "form-check-input", data: { action: "change->auto-submit#submit" } %>
              <%= label_tag "location_#{location.parameterize}", location, class: "form-check-label" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
  <!-- Musicians list -->
  <turbo-frame id="musicians_list">
    <div class="musicians-section" id="musicians-top"
         data-controller="horizontal-scroll"
         data-horizontal-scroll-current-page-value="<%= @pagy.page %>"
         data-horizontal-scroll-total-pages-value="<%= @pagy.pages %>"
         data-horizontal-scroll-items-per-page-value="<%= @pagy.items %>"
         data-horizontal-scroll-base-url-value="<%= musicians_path %>"
         data-horizontal-scroll-query-value="<%= params[:query] %>"
         data-horizontal-scroll-instrument-value="<%= (params[:instrument] || []).to_json %>"
         data-horizontal-scroll-location-value="<%= (params[:location] || []).to_json %>">

      <%# Page Indicator %>
      <% if @pagy.pages > 1 %>
        <nav style="display: flex; justify-content: center; margin-bottom: 20px;" data-horizontal-scroll-target="pageIndicator">
          <div style="display: flex; gap: 8px; align-items: center;">
            <% (1..@pagy.pages).each do |page_num| %>
              <button type="button"
                      data-page-number="<%= page_num %>"
                      data-action="click->horizontal-scroll#goToPage"
                      style="padding: 10px 16px; background: <%= page_num == @pagy.page ? '#C8E938' : '#2a2a2a' %>; color: <%= page_num == @pagy.page ? '#000' : '#fff' %>; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; font-weight: <%= page_num == @pagy.page ? '600' : 'normal' %>;">
                <%= page_num %>
              </button>
            <% end %>
          </div>
        </nav>
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px;" data-horizontal-scroll-target="pageInfo">
          Viewing page <%= @pagy.page %> of <%= @pagy.pages %>
        </p>
      <% end %>

      <div class="record-shelf-container">
        <div class="record-shelf" data-horizontal-scroll-target="shelf">
          <% if @musicians.any? %>
            <% @musicians.each do |musician| %>
              <div class="record-item" data-page="<%= @pagy.page %>">
                <div class="musician-card position-relative">
                  <%= link_to musician_path(musician), class: "text-light text-decoration-none stretched-link", data: { turbo: false } do %>
                    <div class="musician-card-header">
                      <% if musician.avatar.attached? %>
                        <%= cl_image_tag(musician.avatar.key, class: "musician-avatar") %>
                      <% elsif musician.media.attached? %>
                        <% first_file = musician.media.first %>
                        <% if first_file.content_type.start_with?("image") %>
                          <%= cl_image_tag(first_file.key, class: "musician-avatar") %>
                        <% end %>
                      <% else %>
                        <%= image_tag "musician_placeholder.jpg", class: "musician-avatar" %>
                      <% end %>
                      <div class="musician-card-name-wrapper">
                        <h4 class="musician-card-name"><%= musician.name %></h4>
                      </div>
                    </div>
                    <div class="musician-card-details">
                      <p><i class="fa-solid fa-location-dot"></i> <%= musician.location %></p>
                      <p><i class="fa-solid fa-guitar"></i> <%= musician.instrument %></p>
                      <p><i class="fa-solid fa-music"></i> <%= musician.styles %></p>
                      <p><i class="fa-solid fa-pen-to-square"></i> <%= musician.bio %></p>
                    </div>
                  <% end %>
                  <%= button_to "Message", create_or_show_direct_messages_path(recipient_id: musician.user_id), method: :post, class: "btn btn-primary", style: "background-color: #a4fe35ff;", data: { turbo: false } %>
                </div>
              </div>
            <% end %>
          <% else %>
            <em>Sorry, no musicians found.</em>
          <% end %>
        </div>
      </div>
    </div>
  </turbo-frame>
</div>
