<div class="musician-dashboard-container">
  <div class="musician-dashboard-header">
    <h1>Musician Dashboard</h1>
    <h2>Manage your profile, media, and band invitations</h2>
    <%= link_to musician_path(@musician), class: "btn-view-profile" do %>
      <i class="fa-solid fa-eye"></i> View Profile
    <% end %>
  </div>

  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>

  <% if @band_invitation.present? %>
    <div class="musician-dashboard-card full-width invitation-card">
      <div class="musician-card-header">
        <div class="card-icon highlight">
          <i class="fa-solid fa-envelope-open-text"></i>
        </div>
        <h3>Band Invitation</h3>
      </div>
      <div class="invitation-content">
        <p>You have been invited to join <strong><%= @band_invitation.band.name %></strong>!</p>
        <div class="invitation-actions">
          <%= link_to accept_band_invitation_path(@band_invitation.token), class: "btn-accept" do %>
            <i class="fa-solid fa-check"></i> Accept
          <% end %>
          <%= link_to decline_band_invitation_path(@band_invitation.token), class: "btn-decline" do %>
            <i class="fa-solid fa-xmark"></i> Decline
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="musician-stats-grid">
    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @musician.bands.count %></div>
      <div class="stat-label">Bands</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-guitar"></i>
      </div>
      <div class="stat-value"><%= @musician.instrument || "—" %></div>
      <div class="stat-label">Instrument</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-location-dot"></i>
      </div>
      <div class="stat-value"><%= @musician.location || "—" %></div>
      <div class="stat-label">Location</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-images"></i>
      </div>
      <div class="stat-value"><%= (@musician.images.count + @musician.videos.count) %></div>
      <div class="stat-label">Media Files</div>
    </div>
  </div>

  <%# Feed and Analytics Row %>
  <div class="dashboard-feed-analytics-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <%# Feed Section - Left %>
    <div class="musician-dashboard-card" style="height: fit-content;">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-newspaper"></i>
        </div>
        <h3>Feed</h3>
      </div>
      <div style="padding: 20px;">
        <%# New Post Form %>
        <%= form_with model: Post.new, local: true, style: "display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;" do |f| %>
          <%= f.text_area :content, placeholder: "What's on your mind?", rows: 3, style: "width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 1rem; resize: none; box-sizing: border-box;" %>
          <div style="display: flex; align-items: center; gap: 12px;">
            <label style="cursor: pointer; color: #888; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-image"></i>
              <span style="font-size: 0.85rem;">Photo</span>
              <%= f.file_field :images, multiple: true, style: "display: none;", accept: "image/*" %>
            </label>
            <label style="cursor: pointer; color: #888; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-video"></i>
              <span style="font-size: 0.85rem;">Video</span>
              <%= f.file_field :videos, multiple: true, style: "display: none;", accept: "video/*" %>
            </label>
            <div style="flex: 1;"></div>
            <%= f.submit "Post", class: "btn-post" %>
          </div>
        <% end %>

        <%# Posts Feed %>
        <% feed_posts = current_user.feed.includes(:user, :reposts, images_attachments: :blob, videos_attachments: :blob).limit(5) %>
        <% if feed_posts.any? %>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <% feed_posts.each do |post| %>
              <%= render "posts/post", post: post %>
            <% end %>
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <%= link_to posts_path, class: "link-view-all" do %>
              View all posts <i class="fa-solid fa-arrow-right"></i>
            <% end %>
          </div>
        <% else %>
          <div style="text-align: center; padding: 20px;">
            <i class="fa-solid fa-newspaper" style="font-size: 2rem; color: #333; margin-bottom: 8px;"></i>
            <p style="color: #666; margin: 0;">Your feed is empty</p>
            <p style="color: #555; margin: 4px 0 0 0; font-size: 0.85rem;">Follow musicians and add friends to see their posts!</p>
          </div>
        <% end %>
      </div>
    </div>

    <%# Analytics Section - Right %>
    <div class="musician-dashboard-card" style="height: fit-content;">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-chart-line"></i>
        </div>
        <h3>Your Analytics</h3>
        <span style="color: #666; font-size: 0.8rem; margin-left: auto;">Only you can see this</span>
      </div>
      <% if @stats.present? %>
        <div class="musician-stats-grid" style="padding: 20px;">
          <div class="musician-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-user-plus"></i>
            </div>
            <div class="stat-value"><%= @stats[:followers_count] %></div>
            <div class="stat-label">Followers</div>
            <% if @stats[:new_followers_week] > 0 %>
              <div style="color: #C8E938; font-size: 0.75rem; margin-top: 4px;">+<%= @stats[:new_followers_week] %> this week</div>
            <% end %>
          </div>

          <div class="musician-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-eye"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_views_week] %></div>
            <div class="stat-label">Views This Week</div>
            <div style="color: #666; font-size: 0.75rem; margin-top: 4px;"><%= @stats[:profile_views_total] %> total</div>
          </div>

          <div class="musician-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-bookmark"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_saves] %></div>
            <div class="stat-label">Profile Saves</div>
          </div>

          <% if @stats[:mainstage_wins] && @stats[:mainstage_wins] > 0 %>
            <div class="musician-stat-card">
              <div class="stat-icon" style="background: rgba(251, 191, 36, 0.15); color: #fbbf24;">
                <i class="fa-solid fa-trophy"></i>
              </div>
              <div class="stat-value" style="color: #fbbf24;"><%= @stats[:mainstage_wins] %></div>
              <div class="stat-label">MAINSTAGE Wins</div>
            </div>
          <% end %>
        </div>

        <%# Current MAINSTAGE Stats %>
        <div style="border-top: 1px solid #333; margin-top: 16px; padding-top: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <i class="fa-solid fa-fire" style="color: #fbbf24;"></i>
            <span style="font-weight: 600; color: #fff;">Current MAINSTAGE</span>
            <% if @stats[:mainstage_rank] %>
              <span style="margin-left: auto; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #000; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700;">
                Rank #<%= @stats[:mainstage_rank] %>
              </span>
            <% end %>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="background: #252525; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #C8E938; font-size: 1.2rem; font-weight: 700;"><%= @stats[:mainstage_engagement] %></div>
              <div style="color: #888; font-size: 0.7rem;">Engagement</div>
            </div>
            <div style="background: #252525; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #E936AD; font-size: 1.2rem; font-weight: 700;"><%= @stats[:mainstage_votes] %></div>
              <div style="color: #888; font-size: 0.7rem;">Votes</div>
            </div>
            <div style="background: #252525; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #fbbf24; font-size: 1.2rem; font-weight: 700;"><%= @stats[:mainstage_total] %></div>
              <div style="color: #888; font-size: 0.7rem;">Total Score</div>
            </div>
          </div>
          <%= link_to mainstage_path, style: "display: block; text-align: center; margin-top: 12px; color: #fbbf24; font-size: 0.8rem; text-decoration: none;" do %>
            View Full Leaderboard <i class="fa-solid fa-arrow-right"></i>
          <% end %>
        </div>
      <% else %>
        <div style="padding: 40px; text-align: center;">
          <i class="fa-solid fa-chart-line" style="font-size: 2rem; color: #333; margin-bottom: 8px;"></i>
          <p style="color: #666; margin: 0;">No analytics data yet</p>
        </div>
      <% end %>
    </div>
  </div>


  <div class="musician-dashboard-content">
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-pen"></i>
        </div>
        <h3>Edit Profile</h3>
      </div>

      <%= simple_form_for @musician, html: { class: "musician-edit-form", id: "musician-form" } do |f| %>
        <%# Hidden field for banner position - updated by Stimulus controller when position is adjusted %>
        <%= f.hidden_field :banner_position, id: "musician-form-banner-position", value: @musician.banner_position || 50 %>
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-signature"></i> Name
            </label>
            <%= f.input :name, label: false, input_html: { class: "form-input", placeholder: "Your name" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-guitar"></i> Instrument
            </label>
            <%= f.input :instrument, label: false, input_html: { class: "form-input", placeholder: "Your instrument" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-calendar"></i> Age
            </label>
            <%= f.input :age, label: false, input_html: { class: "form-input", placeholder: "Your age" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-music"></i> Styles
            </label>
            <%= f.input :styles, label: false, input_html: { class: "form-input", placeholder: "e.g., Jazz, Rock, Blues" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-location-dot"></i> Location
            </label>
            <%= f.input :location, label: false, input_html: { class: "form-input", placeholder: "Your city" } %>
          </div>

          <div class="form-field full-width">
            <label class="form-label">
              <i class="fa-solid fa-pen"></i> Bio
            </label>
            <%= f.input :bio, as: :text, label: false, input_html: { class: "form-input", placeholder: "Tell us about yourself, your musical journey, and what you're looking for...", rows: 4 } %>
          </div>
        </div>

        <!-- Musician Media Section -->
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4>Upload Media</h4>
              <p>Add new banner, photos, or videos to your profile</p>
            </div>
          </div>

          <!-- Upload Form -->
          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Profile Avatar</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :avatar, accept: "image/*", class: "media-file-input", id: "musician-avatar-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-avatar-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-user-circle"></i>
                  <span><%= @musician.avatar.attached? ? "Replace avatar" : "Choose avatar" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Banner Image</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "musician-banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @musician.banner.attached? ? "Replace banner" : "Choose banner" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Photos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :images, accept: "image/*", multiple: true, class: "media-file-input", id: "musician-images-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-images-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-camera"></i>
                  <span>Add photos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Videos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :videos, accept: "video/*", multiple: true, class: "media-file-input", id: "musician-videos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-videos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-video"></i>
                  <span>Add videos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
        </div>

        <div class="form-submit-wrapper">
          <%= f.submit "Save Changes", class: "btn-save-profile" %>
        </div>
      <% end %>
    </div>

    <%# Current Media Display - Outside form to avoid nested forms %>
    <% if @musician.avatar.attached? || @musician.banner.attached? || @musician.images.attached? || @musician.videos.attached? %>
      <div class="musician-dashboard-card full-width">
        <div class="musician-card-header">
          <div class="card-icon">
            <i class="fa-solid fa-photo-film"></i>
          </div>
          <h3>Current Media</h3>
        </div>
        <div class="current-media-section">
          <% if @musician.avatar.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Avatar</label>
              <div class="current-media-preview avatar-preview">
                <%= image_tag url_for(@musician.avatar), class: "avatar-image-preview" %>
                <%= button_to purge_attachment_musician_path(@musician, attachment_id: @musician.avatar.id),
                    method: :delete,
                    class: "btn-remove-media",
                    data: { turbo_confirm: "Remove your avatar image?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @musician.banner.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Banner</label>
              <div class="current-media-preview banner-preview">
                <%= image_tag url_for(@musician.banner), class: "banner-image-preview" %>
                <%= button_to purge_attachment_musician_path(@musician, attachment_id: @musician.banner.id),
                    method: :delete,
                    class: "btn-remove-media",
                    data: { turbo_confirm: "Remove this banner image?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            </div>

            <!-- Banner Position Adjuster -->
            <div class="media-display-group" data-controller="banner-position">
              <label class="media-group-label">Banner Position</label>
              <p class="banner-position-help">Drag the image up or down to adjust what part is visible</p>
              <div class="banner-position-adjuster">
                <div class="banner-position-preview" data-banner-position-target="preview">
                  <%= image_tag url_for(@musician.banner),
                      data: { banner_position_target: "image" },
                      style: "object-position: center #{@musician.banner_position || 50}%;" %>
                </div>
                <div class="banner-position-controls">
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveUp" title="Move up">
                    <i class="fa-solid fa-chevron-up"></i>
                  </button>
                  <span class="position-value" data-banner-position-target="value"><%= @musician.banner_position || 50 %>%</span>
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveDown" title="Move down">
                    <i class="fa-solid fa-chevron-down"></i>
                  </button>
                </div>
              </div>
              <%= form_with model: @musician, local: true, class: "banner-position-form", data: { banner_position_target: "form" } do |f| %>
                <%= f.hidden_field :banner_position, data: { banner_position_target: "input" }, value: @musician.banner_position || 50 %>
                <%= f.submit "Save Position", class: "btn-save-position" %>
              <% end %>
            </div>
          <% end %>

          <% if @musician.images.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Photos (<%= @musician.images.count %>)</label>
              <div class="current-media-grid">
                <% @musician.images.each do |image| %>
                  <div class="media-grid-item">
                    <%= image_tag url_for(image), class: "preview-image" %>
                    <%= button_to purge_attachment_musician_path(@musician, attachment_id: image.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this photo?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @musician.videos.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Videos (<%= @musician.videos.count %>)</label>
              <div class="current-media-grid videos-grid">
                <% @musician.videos.each do |video| %>
                  <div class="media-grid-item video-item">
                    <video controls class="preview-video">
                      <source src="<%= url_for(video) %>" type="<%= video.content_type %>">
                    </video>
                    <%= button_to purge_attachment_musician_path(@musician, attachment_id: video.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this video?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# ----- SHORTS MANAGEMENT SECTION ----- %>
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-clapperboard"></i>
        </div>
        <h3>Your Shorts</h3>
      </div>

      <%# Upload new short form %>
      <div style="padding: 20px; border-bottom: 1px solid #2a2a2a;">
        <h4 style="color: #fff; font-size: 1rem; margin: 0 0 16px 0;">Upload New Short</h4>
        <%= render "musician_shorts/form", short: @musician.musician_shorts.build, musician: @musician %>
      </div>

      <%# Display existing shorts %>
      <% persisted_shorts = @musician.musician_shorts.select(&:persisted?) %>
      <% if persisted_shorts.any? %>
        <div style="padding: 20px;">
          <h4 style="color: #fff; font-size: 1rem; margin: 0 0 16px 0;">Manage Shorts (<%= persisted_shorts.count %>)</h4>
          <div data-controller="shorts-reorder"
               data-shorts-reorder-musician-id-value="<%= @musician.id %>">
            <div data-shorts-reorder-target="grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px;">
              <% persisted_shorts.each do |short| %>
                <div draggable="true"
                     data-short-id="<%= short.id %>"
                     data-action="dragstart->shorts-reorder#dragStart dragover->shorts-reorder#dragOver drop->shorts-reorder#drop dragend->shorts-reorder#dragEnd"
                     style="position: relative; background: #1e1e1e; border-radius: 12px; overflow: hidden; cursor: grab;">
                  <% if short.video.attached? %>
                    <video preload="metadata" muted style="width: 100%; aspect-ratio: 9/16; object-fit: cover; display: block;">
                      <source src="<%= url_for(short.video) %>" type="<%= short.video.content_type %>">
                    </video>
                  <% end %>
                  <%# Controls overlay %>
                  <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); display: flex; align-items: center; gap: 8px;">
                    <div style="color: #888; cursor: grab;" title="Drag to reorder">
                      <i class="fa-solid fa-grip-vertical"></i>
                    </div>
                    <%= link_to edit_musician_short_path(@musician, short), style: "width: 28px; height: 28px; border-radius: 6px; background: #C8E938; color: #171717; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 0.75rem;", title: "Edit" do %>
                      <i class="fa-solid fa-pen"></i>
                    <% end %>
                    <%= button_to musician_short_path(@musician, short),
                        method: :delete,
                        style: "width: 28px; height: 28px; border-radius: 6px; background: #dc2626; color: #fff; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem;",
                        title: "Delete",
                        data: { turbo_confirm: "Are you sure you want to delete this short?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                  <%# Title overlay %>
                  <div style="position: absolute; top: 8px; left: 8px; right: 8px;">
                    <p style="color: #fff; font-size: 0.7rem; margin: 0; text-shadow: 0 1px 3px rgba(0,0,0,0.8); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= short.title %></p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
          <p style="color: #666; font-size: 0.8rem; margin: 16px 0 0 0; display: flex; align-items: center; gap: 6px;">
            <i class="fa-solid fa-grip-vertical"></i> Drag shorts to reorder them
          </p>
        </div>
      <% end %>
    </div>

    <% if @musician.bands.any? %>
      <div class="musician-dashboard-card full-width">
        <div class="musician-card-header">
          <div class="card-icon">
            <i class="fa-solid fa-users-line"></i>
          </div>
          <h3>Your Bands</h3>
        </div>
        <div class="bands-list">
          <% @musician.bands.each do |band| %>
            <div class="band-item">
              <div class="band-avatar">
                <% if band.banner.attached? %>
                  <%= image_tag url_for(band.banner), class: "band-avatar-img" %>
                <% else %>
                  <i class="fa-solid fa-users"></i>
                <% end %>
              </div>
              <div class="band-info">
                <span class="band-name"><%= band.name %></span>
                <span class="band-members"><%= band.musicians.count %> members</span>
              </div>
              <div class="band-actions">
                <%= link_to band_path(band), class: "btn-band-action" do %>
                  <i class="fa-solid fa-eye"></i>
                <% end %>
                <%= link_to edit_band_path(band), class: "btn-band-action" do %>
                  <i class="fa-solid fa-gear"></i>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="musician-dashboard-card full-width delete-account-card">
      <div class="musician-card-header">
        <div class="card-icon danger">
          <i class="fa-solid fa-trash"></i>
        </div>
        <h3>Delete Account</h3>
      </div>
      <div class="delete-account-section">
        <p>Permanently delete your musician profile. This will remove you from all bands, delete your media, and cannot be undone.</p>
        <%= button_to "Delete My Account", musician_path(@musician),
            method: :delete,
            class: "btn-delete-account",
            data: { turbo_confirm: "Are you sure you want to permanently delete your account? This action cannot be undone." } %>
      </div>
    </div>
  </div>
</div>
