<div class="musician-dashboard-container">
  <div class="musician-dashboard-header">
    <h1>Musician Dashboard</h1>
    <h2>Manage your profile, media, and band invitations</h2>
    <%= link_to musician_path(@musician), class: "btn-view-profile" do %>
      <i class="fa-solid fa-eye"></i> View Profile
    <% end %>
  </div>

  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>

  <% if @band_invitation.present? %>
    <div class="musician-dashboard-card full-width invitation-card">
      <div class="musician-card-header">
        <div class="card-icon highlight">
          <i class="fa-solid fa-envelope-open-text"></i>
        </div>
        <h3>Band Invitation</h3>
      </div>
      <div class="invitation-content">
        <p>You have been invited to join <strong><%= @band_invitation.band.name %></strong>!</p>
        <div class="invitation-actions">
          <%= link_to accept_band_invitation_path(@band_invitation.token), class: "btn-accept" do %>
            <i class="fa-solid fa-check"></i> Accept
          <% end %>
          <%= link_to decline_band_invitation_path(@band_invitation.token), class: "btn-decline" do %>
            <i class="fa-solid fa-xmark"></i> Decline
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="musician-stats-grid">
    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @musician.bands.count %></div>
      <div class="stat-label">Bands</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-guitar"></i>
      </div>
      <div class="stat-value"><%= @musician.instrument || "—" %></div>
      <div class="stat-label">Instrument</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-location-dot"></i>
      </div>
      <div class="stat-value"><%= @musician.location || "—" %></div>
      <div class="stat-label">Location</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-images"></i>
      </div>
      <div class="stat-value"><%= (@musician.images.count + @musician.videos.count) %></div>
      <div class="stat-label">Media Files</div>
    </div>
  </div>

  <div class="musician-dashboard-content">
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-pen"></i>
        </div>
        <h3>Edit Profile</h3>
      </div>

      <%= simple_form_for @musician, html: { class: "musician-edit-form" } do |f| %>
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-signature"></i> Name
            </label>
            <%= f.input :name, label: false, input_html: { class: "form-input", placeholder: "Your name" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-guitar"></i> Instrument
            </label>
            <%= f.input :instrument, label: false, input_html: { class: "form-input", placeholder: "Your instrument" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-calendar"></i> Age
            </label>
            <%= f.input :age, label: false, input_html: { class: "form-input", placeholder: "Your age" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-music"></i> Styles
            </label>
            <%= f.input :styles, label: false, input_html: { class: "form-input", placeholder: "e.g., Jazz, Rock, Blues" } %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-location-dot"></i> Location
            </label>
            <%= f.input :location, label: false, input_html: { class: "form-input", placeholder: "Your city" } %>
          </div>

          <div class="form-field full-width">
            <label class="form-label">
              <i class="fa-solid fa-pen"></i> Bio
            </label>
            <%= f.input :bio, as: :text, label: false, input_html: { class: "form-input", placeholder: "Tell us about yourself, your musical journey, and what you're looking for...", rows: 4 } %>
          </div>
        </div>

        <!-- Musician Media Section -->
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4>Upload Media</h4>
              <p>Add new banner, photos, or videos to your profile</p>
            </div>
          </div>

          <!-- Current Media Display (only shows sections with content) -->
          <% if @musician.banner.attached? || @musician.images.attached? || @musician.videos.attached? %>
            <div class="current-media-section">
              <h4 class="current-media-title"><i class="fa-solid fa-photo-film"></i> Current Media</h4>

              <% if @musician.banner.attached? %>
                <div class="media-display-group">
                  <label class="media-group-label">Banner</label>
                  <div class="current-media-preview banner-preview">
                    <%= image_tag url_for(@musician.banner), class: "banner-image-preview" %>
                    <%= button_to purge_attachment_musician_path(@musician, attachment_id: @musician.banner.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this banner image?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <% if @musician.images.attached? %>
                <div class="media-display-group">
                  <label class="media-group-label">Photos (<%= @musician.images.count %>)</label>
                  <div class="current-media-grid">
                    <% @musician.images.each do |image| %>
                      <div class="media-grid-item">
                        <%= image_tag url_for(image), class: "preview-image" %>
                        <%= button_to purge_attachment_musician_path(@musician, attachment_id: image.id),
                            method: :delete,
                            class: "btn-remove-media",
                            data: { turbo_confirm: "Remove this photo?" } do %>
                          <i class="fa-solid fa-trash"></i>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <% if @musician.videos.attached? %>
                <div class="media-display-group">
                  <label class="media-group-label">Videos (<%= @musician.videos.count %>)</label>
                  <div class="current-media-grid videos-grid">
                    <% @musician.videos.each do |video| %>
                      <div class="media-grid-item video-item">
                        <video controls class="preview-video">
                          <source src="<%= url_for(video) %>" type="<%= video.content_type %>">
                        </video>
                        <%= button_to purge_attachment_musician_path(@musician, attachment_id: video.id),
                            method: :delete,
                            class: "btn-remove-media",
                            data: { turbo_confirm: "Remove this video?" } do %>
                          <i class="fa-solid fa-trash"></i>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Upload Form -->
          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Banner Image</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "musician-banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @musician.banner.attached? ? "Replace banner" : "Choose banner" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Photos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :images, accept: "image/*", multiple: true, class: "media-file-input", id: "musician-images-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-images-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-camera"></i>
                  <span>Add photos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Videos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :videos, accept: "video/*", multiple: true, class: "media-file-input", id: "musician-videos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="musician-videos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-video"></i>
                  <span>Add videos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
        </div>

        <div class="form-submit-wrapper">
          <%= f.submit "Save Changes", class: "btn-save-profile" %>
        </div>
      <% end %>
    </div>

    <% if @musician.bands.any? %>
      <div class="musician-dashboard-card full-width">
        <div class="musician-card-header">
          <div class="card-icon">
            <i class="fa-solid fa-users-line"></i>
          </div>
          <h3>Your Bands</h3>
        </div>
        <div class="bands-list">
          <% @musician.bands.each do |band| %>
            <div class="band-item">
              <div class="band-avatar">
                <% if band.banner.attached? %>
                  <%= image_tag url_for(band.banner), class: "band-avatar-img" %>
                <% else %>
                  <i class="fa-solid fa-users"></i>
                <% end %>
              </div>
              <div class="band-info">
                <span class="band-name"><%= band.name %></span>
                <span class="band-members"><%= band.musicians.count %> members</span>
              </div>
              <div class="band-actions">
                <%= link_to band_path(band), class: "btn-band-action" do %>
                  <i class="fa-solid fa-eye"></i>
                <% end %>
                <%= link_to edit_band_path(band), class: "btn-band-action" do %>
                  <i class="fa-solid fa-gear"></i>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="musician-dashboard-card full-width delete-account-card">
      <div class="musician-card-header">
        <div class="card-icon danger">
          <i class="fa-solid fa-trash"></i>
        </div>
        <h3>Delete Account</h3>
      </div>
      <div class="delete-account-section">
        <p>Permanently delete your musician profile. This will remove you from all bands, delete your media, and cannot be undone.</p>
        <%= button_to "Delete My Account", musician_path(@musician),
            method: :delete,
            class: "btn-delete-account",
            data: { turbo_confirm: "Are you sure you want to permanently delete your account? This action cannot be undone." } %>
      </div>
    </div>
  </div>
</div>
