<% content_for :body_class, "discover-shorts-page" %>

<%# I DONT KNOW WHY BUT I HAD MAD TROUBLE WITH CSS FOR THIS. THATS WHY ITS ALL INLINE STYLES. WHEN I PUT IT IN THE SCSS FILE IT BREAKS??%>

<style>
  /* Hide navbar on mobile for immersive discover experience */
  @media (max-width: 768px) {
    .discover-shorts-page .navbar-lewagon {
      display: none !important;
    }
  }
  html, body {
    overflow: hidden !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  .discover-container {
    overflow-y: scroll !important;
    scroll-snap-type: y mandatory !important;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .discover-container::-webkit-scrollbar {
    display: none;
  }
  .discover-short {
    scroll-snap-align: start !important;
    scroll-snap-stop: always !important;
  }
  .discover-back-btn {
    position: fixed;
    top: 70px;
    left: 20px;
    z-index: 1000;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #2a2a2a;
    color: #fff;
    border-radius: 10px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .discover-back-btn:hover {
    background: #C8E938;
    color: #000;
  }
  /* Mobile back button - inside musician card banner */
  .discover-back-btn-mobile {
    display: none;
  }
  /* Comments panel - adapts to screen size */
  .comments-panel {
    width: 300px;
    height: 92vh;
    background: #1e1e1e;
    border-radius: 16px;
    flex-direction: column;
    overflow: hidden;
  }
  .comments-panel.active {
    display: flex !important;
  }
  /* Desktop video container */
  .video-container {
    height: 95vh;
    width: auto;
  }
  @media (max-width: 992px) {
    .discover-back-btn {
      top: 65px;
      left: 12px;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
  }
  @media (max-width: 768px) {
    /* Hide the fixed back button on mobile */
    .discover-back-btn {
      display: none !important;
    }
    /* Show back button inside the musician card banner */
    .discover-back-btn-mobile {
      display: inline-flex;
      position: absolute;
      top: 10px;
      left: 10px;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .discover-container .discover-short {
      flex-direction: column !important;
      padding: 0 !important;
      gap: 0 !important;
      justify-content: flex-start !important;
      align-items: center !important;
      height: 100vh !important;
      height: 100dvh !important;
      width: 100vw !important;
      overflow: hidden !important;
      position: relative !important;
    }
    /* Hide musician card on mobile - show minimal info on video instead */
    .discover-container .discover-short > div:first-child {
      display: none !important;
    }
    /* Video wrapper takes full screen */
    .video-wrapper {
      display: block !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      padding: 0 !important;
      gap: 0 !important;
      flex: none !important;
    }
    .video-container {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      max-height: none !important;
      max-width: none !important;
      border-radius: 0 !important;
      z-index: 1;
    }
    .video-container video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }
    /* Show musician info overlay on mobile */
    .mobile-musician-info {
      display: flex !important;
    }
    /* Comments panel becomes bottom sheet on mobile */
    .comments-panel {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      width: 100% !important;
      height: 70vh !important;
      border-radius: 20px 20px 0 0 !important;
      z-index: 9999 !important;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    }
  }
</style>

<script>
  function toggleCommentsPanel(shortId) {
    var panel = document.getElementById('comments-panel-' + shortId);
    if (panel.classList.contains('active')) {
      panel.classList.remove('active');
      panel.style.display = 'none';
    } else {
      panel.classList.add('active');
      panel.style.display = 'flex';
    }
  }

  function closeCommentsPanel(shortId) {
    var panel = document.getElementById('comments-panel-' + shortId);
    panel.classList.remove('active');
    panel.style.display = 'none';
  }
</script>

<%# Back button %>
<%= link_to musicians_path, class: "discover-back-btn" do %>
  <i class="fa-solid fa-arrow-left"></i> Back
<% end %>

<%# Vertical scroll feed with musician card on left %>
<div data-controller="shorts-reel" style="height: 100vh; background: #171717; overflow: hidden;">
  <% if @shorts.any? %>
    <div data-shorts-reel-target="container" class="discover-container" style="height: 100vh;">
    <% @shorts.each_with_index do |short, index| %>
      <div data-shorts-reel-target="short" data-index="<%= index %>" class="discover-short" style="height: 100vh; display: flex; align-items: center; justify-content: center; gap: 32px; padding: 24px;">

        <%# Left - Musician Card %>
        <div style="flex: 0 0 280px; background: #1e1e1e; border-radius: 16px; overflow: hidden; align-self: center;">
          <%# Banner %>
          <div style="height: 100px; background: linear-gradient(135deg, #E936AD 0%, #7B2D8E 100%); position: relative;">
            <% if short.musician.banner.attached? %>
              <%= cl_image_tag(short.musician.banner.key, style: "width: 100%; height: 100%; object-fit: cover;") %>
            <% end %>
            <%# Back button inside banner - mobile only %>
            <%= link_to musicians_path, class: "discover-back-btn-mobile" do %>
              <i class="fa-solid fa-arrow-left"></i> Back
            <% end %>
          </div>

          <%# Avatar %>
          <div style="display: flex; justify-content: center; margin-top: -40px; position: relative; z-index: 1;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: #2a2a2a; border: 4px solid #1e1e1e; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <% if short.musician.avatar.attached? %>
                <%= cl_image_tag(short.musician.avatar.key, style: "width: 100%; height: 100%; object-fit: cover;") %>
              <% else %>
                <span style="color: #fff; font-size: 1.5rem; font-weight: 600;"><%= short.musician.name.split.map(&:first).join.upcase[0..1] %></span>
              <% end %>
            </div>
          </div>

          <%# Info %>
          <div style="padding: 12px 20px 20px; text-align: center;">
            <h2 style="color: #fff; font-size: 1.1rem; margin: 0 0 4px 0;"><%= short.musician.name %></h2>
            <p style="color: #888; font-size: 0.85rem; margin: 0 0 10px 0;">
              <%= short.musician.instrument || "Musician" %>
              <% if short.musician.location.present? %>
                <span style="margin: 0 4px;">â€¢</span><%= short.musician.location %>
              <% end %>
            </p>

            <% if short.musician.styles.present? %>
              <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 14px;">
                <% short.musician.styles.split(',').first(3).each do |style| %>
                  <span style="background: #2a2a2a; color: #E936AD; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem;"><%= style.strip %></span>
                <% end %>
              </div>
            <% end %>

            <% if short.musician.bands.any? %>
              <div style="margin-bottom: 14px; padding-top: 10px; border-top: 1px solid #2a2a2a;">
                <p style="color: #666; font-size: 0.7rem; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i class="fa-solid fa-users" style="color: #E936AD;"></i> Bands
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;">
                  <% short.musician.bands.each do |band| %>
                    <%= link_to band_path(band), style: "display: inline-flex; align-items: center; gap: 6px; background: #2a2a2a; padding: 4px 10px; border-radius: 12px; text-decoration: none; transition: background 0.2s;", onmouseover: "this.style.background='#3a3a3a'", onmouseout: "this.style.background='#2a2a2a'" do %>
                      <% if band.banner.attached? %>
                        <%= cl_image_tag(band.banner.key, style: "width: 18px; height: 18px; border-radius: 4px; object-fit: cover;") %>
                      <% else %>
                        <div style="width: 18px; height: 18px; border-radius: 4px; background: #444; display: flex; align-items: center; justify-content: center;">
                          <span style="color: #888; font-size: 0.6rem; font-weight: 600;"><%= band.name[0].upcase %></span>
                        </div>
                      <% end %>
                      <span style="color: #fff; font-size: 0.75rem; font-weight: 500;"><%= band.name %></span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>

            <div style="display: flex; gap: 10px; justify-content: center;">
              <%= link_to musician_path(short.musician), style: "flex: 1; padding: 8px 12px; background: #E936AD; color: #fff; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 500; text-align: center;" do %>
                <i class="fa-solid fa-user"></i> Profile
              <% end %>
              <% if current_user && current_user.id != short.musician.user_id %>
                <%= button_to create_or_show_direct_messages_path(recipient_id: short.musician.user_id), method: :post, style: "flex: 1; padding: 8px 12px; background: #2a2a2a; color: #fff; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer;" do %>
                  <i class="fa-solid fa-envelope"></i> Message
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <%# Right - Short Video with action buttons INSIDE %>
        <div class="video-wrapper" style="display: flex; align-items: center; gap: 16px;">
          <%# Video container %>
          <div data-controller="video-player"
               data-action="mouseenter->video-player#showMute mouseleave->video-player#hideMute"
               class="video-container"
               style="position: relative; border-radius: 16px; overflow: hidden; background: #000;">
            <% if short.video.attached? %>
              <video preload="metadata"
                     loop
                     playsinline
                     muted
                     style="width: 100%; height: 100%; object-fit: contain;"
                     data-video-player-target="video"
                     data-action="click->video-player#toggle">
                <source src="<%= url_for(short.video) %>" type="<%= short.video.content_type %>">
              </video>

              <%# Play button overlay %>
              <div data-video-player-target="playButton"
                   data-action="click->video-player#toggle"
                   style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 72px; height: 72px; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.3s ease;">
                <i class="fa-solid fa-play" style="color: #171717; font-size: 1.75rem; margin-left: 4px;"></i>
              </div>
            <% end %>

            <%# Gradient overlay %>
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 30%); pointer-events: none;"></div>

            <%# Short info overlay - bottom left %>
            <div style="position: absolute; bottom: 16px; left: 16px; right: 80px; z-index: 2;">
              <%# Musician info - shows on mobile where card is hidden %>
              <div class="mobile-musician-info" style="display: none; margin-bottom: 12px;">
                <%= link_to musician_path(short.musician), style: "display: flex; align-items: center; gap: 10px; text-decoration: none;" do %>
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid #fff;">
                    <% if short.musician.avatar.attached? %>
                      <%= cl_image_tag(short.musician.avatar.key, style: "width: 100%; height: 100%; object-fit: cover;") %>
                    <% else %>
                      <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600;"><%= short.musician.name[0] %></div>
                    <% end %>
                  </div>
                  <div>
                    <div style="color: #fff; font-weight: 600; font-size: 0.95rem;"><%= short.musician.name %></div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem;"><%= short.musician.instrument %></div>
                  </div>
                <% end %>
              </div>
              <h3 style="color: #fff; font-size: 1rem; margin: 0 0 4px 0; font-weight: 600;"><%= short.title %></h3>
              <% if short.description.present? %>
                <p style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin: 0;"><%= truncate(short.description, length: 80) %></p>
              <% end %>
            </div>

            <%# Action buttons - bottom right, INSIDE video, always visible %>
            <div class="video-actions" style="position: absolute; bottom: 16px; right: 16px; display: flex; flex-direction: column; gap: 12px; align-items: center; z-index: 5;">
              <%# Like button %>
              <%= render "musician_shorts/like_button", short: short %>

              <%# Comment button %>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                <button onclick="toggleCommentsPanel(<%= short.id %>)"
                        style="width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
                  <i class="fa-regular fa-comment" style="color: #fff; font-size: 1.2rem;"></i>
                </button>
                <span id="comment-count-<%= short.id %>" style="color: #fff; font-size: 0.75rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);"><%= short.short_comments.count %></span>
              </div>

              <%# Challenge button %>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                <% challenge = short.challenges.first %>
                <% if challenge&.open? %>
                  <%# Open challenge - fire icon, accepting responses %>
                  <%= link_to challenge_path(challenge), style: "width: 44px; height: 44px; border-radius: 50%; background: #E936AD; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none;" do %>
                    <i class="fa-solid fa-fire" style="color: #fff; font-size: 1.1rem;"></i>
                  <% end %>
                  <span style="color: #E936AD; font-size: 0.7rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">OPEN</span>
                <% elsif challenge&.voting? %>
                  <%# Voting phase - vote icon %>
                  <%= link_to challenge_path(challenge), style: "width: 44px; height: 44px; border-radius: 50%; background: #fbbf24; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none;" do %>
                    <i class="fa-solid fa-check-to-slot" style="color: #000; font-size: 1.1rem;"></i>
                  <% end %>
                  <span style="color: #fbbf24; font-size: 0.7rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">VOTE</span>
                <% elsif challenge&.closed? %>
                  <%# Closed challenge - trophy icon %>
                  <%= link_to challenge_path(challenge), style: "width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #fbbf24; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none;" do %>
                    <i class="fa-solid fa-trophy" style="color: #fbbf24; font-size: 1.1rem;"></i>
                  <% end %>
                  <span style="color: #888; font-size: 0.7rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">ENDED</span>
                <% elsif current_user&.musician == short.musician %>
                  <%# Owner can create a challenge from their short %>
                  <%= link_to new_challenge_path(original_short_id: short.id), style: "width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none;" do %>
                    <i class="fa-solid fa-bolt" style="color: #fff; font-size: 1.1rem;"></i>
                  <% end %>
                  <span style="color: #fff; font-size: 0.7rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">Challenge</span>
                <% end %>
              </div>

              <%# Mute button %>
              <button data-video-player-target="muteButton"
                      data-action="click->video-player#toggleMute"
                      style="width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="fa-solid fa-volume-xmark" data-video-player-target="muteIcon" style="color: #fff; font-size: 1rem;"></i>
              </button>
            </div>
          </div>

          <%# Comments panel - appears next to video on desktop, bottom sheet on mobile %>
          <div id="comments-panel-<%= short.id %>" class="comments-panel" style="display: none;">
            <div style="padding: 16px; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; align-items: center;">
              <h3 style="color: #fff; margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                <i class="fa-regular fa-comment" style="color: #E936AD;"></i>
                Comments
              </h3>
              <button onclick="closeCommentsPanel(<%= short.id %>)"
                      style="background: none; border: none; color: #888; cursor: pointer; font-size: 1.2rem; padding: 4px;">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 16px;">
              <%= render "musician_shorts/comments_section", short: short %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
      <i class="fa-solid fa-film" style="font-size: 4rem; color: rgba(255,255,255,0.15); margin-bottom: 20px;"></i>
      <h3 style="color: #fff; margin: 0 0 8px 0;">No shorts yet</h3>
      <p style="color: #888; margin: 0;">Be the first to upload a short!</p>
    </div>
  <% end %>
</div>
