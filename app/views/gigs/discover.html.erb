<div class="discover-page">
  <div class="discover-header">
    <div>
      <h1 class="discover-title">
        <i class="fa-solid fa-compass"></i> Discover Gigs
      </h1>
      <p class="discover-subtitle">Find upcoming shows based on your interests</p>
    </div>
    <%= link_to swipe_gigs_path, class: "btn-swipe-mode" do %>
      <i class="fa-solid fa-fire"></i> Swipe Mode
    <% end %>
  </div>

  <%# Filters %>
  <div class="discover-filters">
    <%= form_with url: discover_gigs_path, method: :get, local: true, class: "discover-filter-form" do %>
      <%# City Filter %>
      <div class="discover-filter-field">
        <label class="discover-filter-label">
          <i class="fa-solid fa-location-dot"></i> City
        </label>
        <%= select_tag :city,
            options_for_select([["All Cities", ""]] + @cities.map { |c| [c, c] }, params[:city]),
            class: "discover-filter-select" %>
      </div>

      <%# Genre Filter %>
      <div class="discover-filter-field">
        <label class="discover-filter-label">
          <i class="fa-solid fa-music"></i> Genre
        </label>
        <%= text_field_tag :genre, params[:genre],
            placeholder: "e.g. Rock, Jazz, Electronic",
            class: "discover-filter-input" %>
      </div>

      <%# Following Filter %>
      <% if current_user && current_user.followed_bands.any? %>
        <div class="discover-filter-checkbox">
          <%= check_box_tag :following, "1", params[:following].present? %>
          <label for="following">
            <i class="fa-solid fa-heart"></i> Bands I follow
          </label>
        </div>
      <% end %>

      <div class="discover-filter-actions">
        <%= submit_tag "Search", class: "btn-discover-search" %>
        <%= link_to "Clear", discover_gigs_path, class: "btn-discover-clear" %>
      </div>
    <% end %>
  </div>

  <%# Results %>
  <% if @gigs.any? %>
    <div class="discover-results">
      <% @gigs.each do |gig| %>
        <div class="discover-gig-card">
          <div class="discover-gig-content">
            <div class="discover-gig-info">
              <h3 class="discover-gig-name"><%= gig.name %></h3>

              <p class="discover-gig-meta">
                <i class="fa-solid fa-location-dot"></i>
                <%= link_to gig.venue.name, venue_path(gig.venue) %>
                <% if gig.venue.city.present? %>
                  <span class="city">&bull; <%= gig.venue.city %></span>
                <% end %>
              </p>

              <p class="discover-gig-meta">
                <i class="fa-solid fa-calendar"></i>
                <%= gig.date.strftime("%A, %B %d, %Y") %>
                <% if gig.start_time.present? %>
                  at <%= gig.start_time.strftime("%l:%M %p") %>
                <% end %>
              </p>

              <% if gig.bands.any? %>
                <div class="discover-gig-bands">
                  <% gig.bands.each do |band| %>
                    <%= link_to band_path(band), class: "discover-band-tag" do %>
                      <i class="fa-solid fa-users"></i>
                      <%= band.name %>
                      <% if current_user&.followed_bands&.include?(band) %>
                        <i class="fa-solid fa-heart followed"></i>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>

              <% if gig.ticket_price.present? && gig.ticket_price > 0 %>
                <p class="discover-gig-price">
                  <i class="fa-solid fa-ticket"></i> $<%= number_with_precision(gig.ticket_price, precision: 2) %>
                </p>
              <% end %>
            </div>

            <div class="discover-gig-actions">
              <%= render "gig_attendances/buttons", gig: gig %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="discover-empty">
      <i class="fa-solid fa-calendar-xmark"></i>
      <h3>No gigs found</h3>
      <p>
        <% if params[:city].present? || params[:genre].present? || params[:following].present? %>
          Try adjusting your filters to find more shows.
        <% else %>
          No upcoming gigs at the moment. Check back soon!
        <% end %>
      </p>
    </div>
  <% end %>
</div>
