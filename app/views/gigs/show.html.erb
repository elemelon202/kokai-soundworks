<div class="container">
  <h2><%= @gig.name %></h2>
  <li><%= "Date: #{@gig.date}" %></li>
  <li><%= "Time: #{@gig.start_time} - #{@gig.end_time}" %></li>

  <%# Apply to Play Section - for band leaders %>
  <% if current_user && current_user.led_bands.any? %>
    <div style="background: #1e1e1e; border-radius: 12px; padding: 20px; margin: 20px 0;">
      <h3 style="color: #fff; margin: 0 0 16px 0;">
        <i class="fa-solid fa-guitar" style="color: #C8E938;"></i> Apply to Play
      </h3>
      <% available_bands = current_user.led_bands.where.not(id: @gig.bands.pluck(:id)).where.not(id: @gig.gig_applications.pluck(:band_id)) %>
      <% if available_bands.any? %>
        <%= form_with url: gig_gig_applications_path(@gig), method: :post, local: true, style: "display: flex; flex-direction: column; gap: 12px;" do |f| %>
          <div>
            <label style="color: #888; font-size: 0.85rem; display: block; margin-bottom: 6px;">Select your band</label>
            <%= select_tag "gig_application[band_id]",
                options_from_collection_for_select(available_bands, :id, :name),
                style: "width: 100%; background: #252525; border: 1px solid #333; border-radius: 8px; padding: 10px 12px; color: #fff; font-size: 0.9rem;" %>
          </div>
          <div>
            <label style="color: #888; font-size: 0.85rem; display: block; margin-bottom: 6px;">Message to venue (optional)</label>
            <%= text_area_tag "gig_application[message]", nil,
                placeholder: "Tell the venue why your band would be a great fit...",
                rows: 3,
                style: "width: 100%; background: #252525; border: 1px solid #333; border-radius: 8px; padding: 10px 12px; color: #fff; font-size: 0.9rem; resize: none; box-sizing: border-box;" %>
          </div>
          <%= submit_tag "Submit Application", style: "background: #C8E938; color: #171717; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; width: fit-content;" %>
        <% end %>
      <% else %>
        <% applied_bands = current_user.led_bands.where(id: @gig.gig_applications.pluck(:band_id)) %>
        <% booked_bands = current_user.led_bands.where(id: @gig.bands.pluck(:id)) %>
        <% if booked_bands.any? %>
          <p style="color: #C8E938; margin: 0;">
            <i class="fa-solid fa-check-circle"></i> Your band is already booked for this gig!
          </p>
        <% elsif applied_bands.any? %>
          <p style="color: #fbbf24; margin: 0;">
            <i class="fa-solid fa-clock"></i> You've already applied with your band. Waiting for venue response.
          </p>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%# Venue Owner Section %>
  <% if current_user && @gig.venue.user_id == current_user.id %>
    <h1>Book a Band for <%= @gig.name %></h1>
    <%= simple_form_for [@gig, @booking] do |f| %>
      <%= f.association :band, collection: Band.all, prompt: "Select a band" %>
      <%= f.submit "Invite a band", class: "btn btn-primary" %>
    <% end %>

    <%# Pending Applications %>
    <% pending_applications = @gig.gig_applications.pending.includes(:band) %>
    <% if pending_applications.any? %>
      <div style="background: #1e1e1e; border-radius: 12px; padding: 20px; margin: 20px 0;">
        <h3 style="color: #C8E938; margin: 0 0 16px 0;">
          <i class="fa-solid fa-inbox"></i> Pending Applications (<%= pending_applications.count %>)
        </h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <% pending_applications.each do |application| %>
            <div style="background: #252525; padding: 12px 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div>
                <%= link_to application.band.name, band_path(application.band), style: "color: #fff; text-decoration: none; font-weight: 600;" %>
                <% if application.message.present? %>
                  <p style="color: #888; margin: 4px 0 0 0; font-size: 0.85rem; font-style: italic;">"<%= truncate(application.message, length: 60) %>"</p>
                <% end %>
              </div>
              <div style="display: flex; gap: 8px;">
                <%= button_to approve_gig_application_path(application), method: :patch, style: "background: #C8E938; color: #171717; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;" do %>
                  <i class="fa-solid fa-check"></i> Approve
                <% end %>
                <%= button_to reject_gig_application_path(application), method: :patch, style: "background: #ff4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;" do %>
                  <i class="fa-solid fa-xmark"></i> Reject
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <h2>Booked Bands</h2>
  <% if @gig.bookings.any? %>
    <% @gig.bookings.each do |booking| %>
      <p>
        <%= booking.band.name %>
        <% if current_user && @gig.venue.user_id == current_user.id %>
          <%= link_to "Remove", gig_booking_path(@gig, booking),
              data: { turbo_method: :delete, confirm: "Are you sure?" } %>
        <% end %>
      </p>
    <% end %>
  <% else %>
    <p>No bands booked yet.</p>
  <% end %>
  <% if policy(@gig).edit? %>
    <%= link_to "Edit Gig", edit_gig_path(@gig), class: "btn btn-primary" %>
  <% end %>
  <%= link_to "Back to venue", request.referer || root_path, class: "btn btn-secondary" %>
</div>
