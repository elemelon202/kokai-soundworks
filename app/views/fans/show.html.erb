<div class="fan-show-page" data-controller="tabs">


    <%# ----- PROFILE HEADER ----- %>
    <div class="profile-header">
      <div class="profile-header-left">
        <div class="profile-avatar">
          <% if @fan.avatar.attached? %>
            <%= cl_image_tag(@fan.avatar.key, class: "profile-avatar-image") %>
          <% else %>
            <%= @fan.display_name&.split&.map(&:first)&.join&.upcase&.slice(0, 2) || "FN" %>
          <% end %>
        </div>
        <div class="profile-info">
          <h1 class="profile-name"><%= @fan.display_name || @fan.user.username %></h1>
          <div class="profile-meta">
            <span class="profile-badge">Fan</span>
            <% if @fan.location.present? %>
              <span class="profile-location"><i class="fa-solid fa-location-dot"></i> <%= @fan.location %></span>
            <% end %>
          </div>
          <div class="profile-stats-inline">
            <span>Following: <strong><%= @fan.user.followed_musicians.count + @fan.user.followed_bands.count %></strong></span>
            <span>Friends: <strong><%= @fan.user.friends.count %></strong></span>
            <span>Gigs Attended: <strong><%= @past_gigs.count %></strong></span>
          </div>
          <%# Social Links %>
          <% if @fan.social_instagram.present? || @fan.social_twitter.present? || @fan.social_spotify.present? %>
            <div class="fan-social-links">
              <% if @fan.social_instagram.present? %>
                <%= link_to "https://instagram.com/#{@fan.social_instagram}", target: "_blank", title: "Instagram" do %>
                  <i class="fa-brands fa-instagram"></i>
                <% end %>
              <% end %>
              <% if @fan.social_twitter.present? %>
                <%= link_to "https://twitter.com/#{@fan.social_twitter}", target: "_blank", title: "X / Twitter" do %>
                  <i class="fa-brands fa-x-twitter"></i>
                <% end %>
              <% end %>
              <% if @fan.social_spotify.present? %>
                <%= link_to @fan.social_spotify.start_with?('http') ? @fan.social_spotify : "https://open.spotify.com/user/#{@fan.social_spotify}", target: "_blank", title: "Spotify" do %>
                  <i class="fa-brands fa-spotify"></i>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
      <div class="profile-header-right">
        <button class="btn-icon"><i class="fa-solid fa-share-nodes"></i></button>
        <% if current_user && current_user.id == @fan.user_id %>
          <%= link_to edit_fan_path(@fan), class: "btn-edit-profile" do %>
            <i class="fa-solid fa-pen"></i> Edit Profile
          <% end %>
        <% elsif current_user && current_user.id != @fan.user_id %>
          <%= button_to create_or_show_direct_messages_path(recipient_id: @fan.user_id), method: :post, class: "btn-message-profile" do %>
            <i class="fa-solid fa-envelope"></i> Message
          <% end %>
          <%= render "friendships/friend_button", user: @fan.user %>
        <% end %>
      </div>
    </div>
  <%# ----- BANNER ----- %>
    <div class="fan-banner">
      <% if @fan.banner.attached? %>
        <%= cl_image_tag(@fan.banner.key) %>
      <% else %>
        <div class="fan-banner-empty">
          <i class="fa-solid fa-image"></i>
        </div>
      <% end %>
    </div>
    <%# ----- BOTTOM PROFILE CONTENT ----- %>
    <div class="bottom-profile-content">
      <%# ----- LEFT COLUMN: ABOUT & ACTIVITY ------ %>
      <div class="about-card">
        <h3 class="section-title">About</h3>
        <p class="about-text"><%= @fan.bio.present? ? @fan.bio : "No bio yet." %></p>

        <%# Favorite Genres %>
        <% if @fan.favorite_genres.present? %>
          <h4 class="subsection-title fan-subsection-genres">Favorite Genres</h4>
          <div class="tag-list">
            <% @fan.favorite_genres.split(',').each do |genre| %>
              <span class="tag"><%= genre.strip %></span>
            <% end %>
          </div>
        <% end %>

        <%# Upcoming Gigs %>
        <% if @upcoming_gigs.any? %>
          <div class="fan-section">
            <h3 class="section-title fan-section-title">
              <i class="fa-solid fa-calendar lime"></i> Upcoming Gigs
            </h3>
            <div class="fan-gigs-list">
              <% @upcoming_gigs.limit(5).each do |gig| %>
                <div class="fan-gig-item">
                  <div>
                    <h4><%= gig.name %></h4>
                    <p class="gig-meta">
                      <%= gig.venue.name %> &bull; <%= gig.date.strftime("%b %d, %Y") %>
                    </p>
                  </div>
                  <%= render "gig_attendances/buttons", gig: gig %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Following %>
        <div class="fan-section">
          <h3 class="section-title fan-section-title">
            <i class="fa-solid fa-heart pink"></i> Following
          </h3>
          <div class="fan-following-grid">
            <% @following_musicians.limit(6).each do |musician| %>
              <%= link_to musician_path(musician), class: "fan-following-item" do %>
                <div class="fan-following-avatar musician">
                  <% if musician.avatar.attached? %>
                    <%= cl_image_tag(musician.avatar.key) %>
                  <% else %>
                    <%= musician.name.split.map(&:first).join.upcase[0..1] %>
                  <% end %>
                </div>
                <span class="name"><%= musician.name %></span>
              <% end %>
            <% end %>
            <% @following_bands.limit(6).each do |band| %>
              <%= link_to band_path(band), class: "fan-following-item" do %>
                <div class="fan-following-avatar band">
                  <%= band.name.split.map(&:first).join.upcase[0..1] %>
                </div>
                <span class="name"><%= band.name %></span>
              <% end %>
            <% end %>
          </div>
          <% if @following_musicians.count + @following_bands.count > 12 %>
            <%= link_to following_fan_path(@fan), class: "fan-view-all-link" do %>
              View all <%= @following_musicians.count + @following_bands.count %> following <i class="fa-solid fa-arrow-right"></i>
            <% end %>
          <% end %>
        </div>

        <%# Posts %>
        <% fan_posts = @fan.user.posts.where(band_id: nil).includes(:post_likes, :post_comments, images_attachments: :blob, videos_attachments: :blob).recent.limit(5) %>
        <% if fan_posts.any? %>
          <div class="fan-section">
            <h3 class="section-title fan-section-title">
              <i class="fa-solid fa-newspaper lime"></i> Posts
            </h3>
            <div class="fan-posts-section">
              <% fan_posts.each do |post| %>
                <%= render "posts/post", post: post %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# ----- RIGHT COLUMN: STATS & GIGS ------ %>
      <div class="right-column">
        <div class="stats-card">
          <h3 class="section-title">Stats</h3>
          <div class="stat-row">
            <span class="stat-label">Musicians Following</span>
            <span class="stat-value"><%= @following_musicians.count %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Bands Following</span>
            <span class="stat-value"><%= @following_bands.count %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Friends</span>
            <span class="stat-value"><%= @fan.user.friends.count %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Gigs Attended</span>
            <span class="stat-value"><%= @past_gigs.count %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Upcoming Gigs</span>
            <span class="stat-value"><%= @upcoming_gigs.count %></span>
          </div>
        </div>

        <%# Past Gigs %>
        <% if @past_gigs.any? %>
          <div class="fan-past-gigs-card">
            <h3 class="section-title fan-section-title">
              <i class="fa-solid fa-ticket lime"></i> Gig History
            </h3>
            <div class="fan-past-gigs-list">
              <% @past_gigs.limit(5).each do |gig| %>
                <div class="fan-past-gig-item">
                  <p class="gig-name"><%= gig.name %></p>
                  <p class="gig-date"><%= gig.date.strftime("%b %d, %Y") %></p>
                </div>
              <% end %>
            </div>
            <% if @past_gigs.count > 5 %>
              <%= link_to gigs_fan_path(@fan), class: "fan-view-link" do %>
                View all <i class="fa-solid fa-arrow-right"></i>
              <% end %>
            <% end %>
          </div>
        <% end %>

        <%# Saved Profiles %>
        <% saved_count = @fan.user.saved_musicians.count + @fan.user.saved_bands.count %>
        <% if saved_count > 0 %>
          <div class="fan-saved-card">
            <h3 class="section-title fan-section-title">
              <i class="fa-solid fa-bookmark lime"></i> Saved
            </h3>
            <p class="saved-count">
              <%= saved_count %> saved profiles
            </p>
            <%= link_to saved_fan_path(@fan), class: "fan-view-link" do %>
              View saved <i class="fa-solid fa-arrow-right"></i>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
