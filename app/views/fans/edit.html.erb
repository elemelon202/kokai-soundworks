<div class="musician-dashboard-container">
  <div class="musician-dashboard-header">
    <h1>Dashboard</h1>
    <h2>Manage your profile and discover music</h2>
    <%= link_to fan_path(@fan), class: "btn-view-profile" do %>
      <i class="fa-solid fa-eye"></i> View Profile
    <% end %>
  </div>

  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>

  <div class="musician-stats-grid">
    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-heart"></i>
      </div>
      <div class="stat-value"><%= @fan.user.followed_musicians.count + @fan.user.followed_bands.count %></div>
      <div class="stat-label">Following</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-user-group"></i>
      </div>
      <div class="stat-value"><%= @fan.user.friends.count %></div>
      <div class="stat-label">Friends</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-ticket"></i>
      </div>
      <div class="stat-value"><%= @fan.user.gig_attendances.attended.count %></div>
      <div class="stat-label">Gigs Attended</div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-bookmark"></i>
      </div>
      <div class="stat-value"><%= @fan.user.saved_musicians.count + @fan.user.saved_bands.count %></div>
      <div class="stat-label">Saved</div>
    </div>
  </div>

  <%# Feed and Quick Links Row %>
  <div class="dashboard-feed-analytics-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <%# Feed Section - Left %>
    <div class="musician-dashboard-card" style="height: fit-content;">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-newspaper"></i>
        </div>
        <h3>Feed</h3>
      </div>
      <div style="padding: 20px;">
        <%# New Post Form %>
        <%= form_with model: Post.new, local: true, style: "display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;" do |f| %>
          <%= f.text_area :content, placeholder: "What's on your mind?", rows: 3, style: "width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 1rem; resize: none; box-sizing: border-box;" %>
          <div style="display: flex; align-items: center; gap: 12px;">
            <label style="cursor: pointer; color: #888; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-image"></i>
              <span style="font-size: 0.85rem;">Photo</span>
              <%= f.file_field :images, multiple: true, style: "display: none;", accept: "image/*" %>
            </label>
            <label style="cursor: pointer; color: #888; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-video"></i>
              <span style="font-size: 0.85rem;">Video</span>
              <%= f.file_field :videos, multiple: true, style: "display: none;", accept: "video/*" %>
            </label>
            <div style="flex: 1;"></div>
            <%= f.submit "Post", class: "btn-post" %>
          </div>
        <% end %>

        <%# Posts Feed %>
        <% feed_posts = @fan.user.feed.includes(:user, :reposts, images_attachments: :blob, videos_attachments: :blob).limit(5) %>
        <% if feed_posts.any? %>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <% feed_posts.each do |post| %>
              <%= render "posts/post", post: post %>
            <% end %>
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <%= link_to posts_path, class: "link-view-all" do %>
              View all posts <i class="fa-solid fa-arrow-right"></i>
            <% end %>
          </div>
        <% else %>
          <div style="text-align: center; padding: 20px;">
            <i class="fa-solid fa-newspaper" style="font-size: 2rem; color: #333; margin-bottom: 8px;"></i>
            <p style="color: #666; margin: 0;">Your feed is empty</p>
            <p style="color: #555; margin: 4px 0 0 0; font-size: 0.85rem;">Follow musicians and add friends to see their posts!</p>
          </div>
        <% end %>
      </div>
    </div>

    <%# Quick Links Section - Right %>
    <div class="musician-dashboard-card" style="height: fit-content;">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-compass"></i>
        </div>
        <h3>Quick Links</h3>
      </div>
      <div style="padding: 20px; display: flex; flex-direction: column; gap: 12px;">
        <%= link_to musicians_path, style: "display: flex; align-items: center; gap: 12px; padding: 16px; background: #252525; border-radius: 8px; color: #fff; text-decoration: none; transition: background 0.2s;", onmouseover: "this.style.background='#333'" , onmouseout: "this.style.background='#252525'" do %>
          <i class="fa-solid fa-guitar" style="color: #C8E938; font-size: 1.2rem;"></i>
          <div>
            <p style="margin: 0; font-weight: 600;">Discover Musicians</p>
            <p style="margin: 0; font-size: 0.8rem; color: #888;">Find new artists to follow</p>
          </div>
        <% end %>

        <%= link_to bands_path, style: "display: flex; align-items: center; gap: 12px; padding: 16px; background: #252525; border-radius: 8px; color: #fff; text-decoration: none; transition: background 0.2s;", onmouseover: "this.style.background='#333'" , onmouseout: "this.style.background='#252525'" do %>
          <i class="fa-solid fa-users" style="color: #E936AD; font-size: 1.2rem;"></i>
          <div>
            <p style="margin: 0; font-weight: 600;">Browse Bands</p>
            <p style="margin: 0; font-size: 0.8rem; color: #888;">Explore local bands</p>
          </div>
        <% end %>

        <%= link_to venues_path, style: "display: flex; align-items: center; gap: 12px; padding: 16px; background: #252525; border-radius: 8px; color: #fff; text-decoration: none; transition: background 0.2s;", onmouseover: "this.style.background='#333'" , onmouseout: "this.style.background='#252525'" do %>
          <i class="fa-solid fa-location-dot" style="color: #fbbf24; font-size: 1.2rem;"></i>
          <div>
            <p style="margin: 0; font-weight: 600;">Find Venues</p>
            <p style="margin: 0; font-size: 0.8rem; color: #888;">Discover live music spots</p>
          </div>
        <% end %>

        <%= link_to gigs_fan_path(@fan), style: "display: flex; align-items: center; gap: 12px; padding: 16px; background: #252525; border-radius: 8px; color: #fff; text-decoration: none; transition: background 0.2s;", onmouseover: "this.style.background='#333'" , onmouseout: "this.style.background='#252525'" do %>
          <i class="fa-solid fa-ticket" style="color: #C8E938; font-size: 1.2rem;"></i>
          <div>
            <p style="margin: 0; font-weight: 600;">My Gigs</p>
            <p style="margin: 0; font-size: 0.8rem; color: #888;">Upcoming and past shows</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Upcoming Shows in the Area %>
  <div class="musician-dashboard-card" style="margin-bottom: 24px;">
    <div class="musician-card-header">
      <div class="card-icon">
        <i class="fa-solid fa-calendar-days"></i>
      </div>
      <h3>Upcoming Shows <%= @fan.location.present? ? "in #{@fan.location.split(',').first.strip}" : "Near You" %></h3>
    </div>
    <div style="padding: 20px;">
      <% if @area_gigs.any? %>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <% @area_gigs.each do |gig| %>
            <div style="background: #252525; padding: 16px; border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1;">
                  <h4 style="color: #fff; margin: 0 0 6px 0; font-size: 1rem;"><%= gig.name %></h4>
                  <p style="color: #888; margin: 0 0 4px 0; font-size: 0.85rem;">
                    <i class="fa-solid fa-location-dot" style="color: #C8E938; margin-right: 4px;"></i>
                    <%= link_to gig.venue.name, venue_path(gig.venue), style: "color: #C8E938; text-decoration: none;" %>
                    <% if gig.venue.city.present? %>
                      <span style="color: #666;"> &bull; <%= gig.venue.city %></span>
                    <% end %>
                  </p>
                  <p style="color: #888; margin: 0 0 4px 0; font-size: 0.85rem;">
                    <i class="fa-solid fa-clock" style="color: #C8E938; margin-right: 4px;"></i>
                    <%= gig.date.strftime("%A, %B %d") %>
                    <% if gig.start_time.present? %>
                      at <%= gig.start_time.strftime("%l:%M %p") %>
                    <% end %>
                  </p>
                  <% if gig.bands.any? %>
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                      <% gig.bands.limit(3).each do |band| %>
                        <%= link_to band_path(band), style: "text-decoration: none;" do %>
                          <span style="background: #333; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;">
                            <i class="fa-solid fa-users" style="color: #E936AD; font-size: 0.65rem;"></i>
                            <%= band.name %>
                          </span>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <div style="display: flex; align-items: center;">
                  <%= render "gig_attendances/buttons", gig: gig %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
        <div style="text-align: center; margin-top: 16px;">
          <%= link_to discover_gigs_path, class: "link-view-all" do %>
            Discover more gigs <i class="fa-solid fa-arrow-right"></i>
          <% end %>
        </div>
      <% else %>
        <div style="text-align: center; padding: 30px;">
          <i class="fa-solid fa-calendar-xmark" style="font-size: 2.5rem; color: #333; margin-bottom: 12px;"></i>
          <p style="color: #888; margin: 0 0 8px 0;">No upcoming shows found<%= @fan.location.present? ? " in your area" : "" %>.</p>
          <p style="color: #666; margin: 0; font-size: 0.85rem;">
            <% unless @fan.location.present? %>
              Add your location above to see local shows, or
            <% end %>
            <%= link_to "browse all upcoming gigs", discover_gigs_path, style: "color: #C8E938;" %>.
          </p>
        </div>
      <% end %>
    </div>
  </div>

  <div class="musician-dashboard-content">
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-pen"></i>
        </div>
        <h3>Edit Profile</h3>
      </div>

      <%= form_with model: @fan, local: true, class: "musician-edit-form" do |f| %>
        <% if @fan.errors.any? %>
          <div style="background: #ff4444; padding: 12px 16px; border-radius: 8px; color: #fff; margin-bottom: 20px;">
            <ul style="margin: 0; padding-left: 20px;">
              <% @fan.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-signature"></i> Display Name
            </label>
            <%= f.text_field :display_name, class: "form-input", placeholder: "Your display name" %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-location-dot"></i> Location
            </label>
            <%= f.text_field :location, class: "form-input", placeholder: "City, Country" %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-music"></i> Favorite Genres
            </label>
            <%= f.text_field :favorite_genres, class: "form-input", placeholder: "Jazz, Rock, Electronic, Hip-Hop..." %>
            <p style="color: #666; font-size: 0.75rem; margin: 4px 0 0 0;">Separate genres with commas</p>
          </div>

          <div class="form-field full-width">
            <label class="form-label">
              <i class="fa-solid fa-pen"></i> Bio
            </label>
            <%= f.text_area :bio, class: "form-input", placeholder: "Tell us about yourself and your music taste...", rows: 4 %>
          </div>
        </div>

        <%# Social Links Section %>
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #333;">
          <h4 style="color: #fff; font-size: 1rem; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-link" style="color: #C8E938;"></i> Social Links
          </h4>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">
                <i class="fa-brands fa-instagram"></i> Instagram
              </label>
              <%= f.text_field :social_instagram, class: "form-input", placeholder: "username (without @)" %>
            </div>

            <div class="form-field">
              <label class="form-label">
                <i class="fa-brands fa-x-twitter"></i> X / Twitter
              </label>
              <%= f.text_field :social_twitter, class: "form-input", placeholder: "username (without @)" %>
            </div>

            <div class="form-field">
              <label class="form-label">
                <i class="fa-brands fa-spotify"></i> Spotify Profile
              </label>
              <%= f.text_field :social_spotify, class: "form-input", placeholder: "Spotify profile URL or username" %>
            </div>
          </div>
        </div>

        <%# Media Upload Section %>
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4>Upload Media</h4>
              <p>Add your avatar and banner image</p>
            </div>
          </div>

          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Profile Avatar</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :avatar, accept: "image/*", class: "media-file-input", id: "fan-avatar-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="fan-avatar-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-user-circle"></i>
                  <span><%= @fan.avatar.attached? ? "Replace avatar" : "Choose avatar" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Banner Image</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "fan-banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="fan-banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @fan.banner.attached? ? "Replace banner" : "Choose banner" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
        </div>

        <div class="form-submit-wrapper">
          <%= f.submit "Save Changes", class: "btn-save-profile" %>
        </div>
      <% end %>
    </div>

    <%# Current Media Display %>
    <% if @fan.avatar.attached? || @fan.banner.attached? %>
      <div class="musician-dashboard-card full-width">
        <div class="musician-card-header">
          <div class="card-icon">
            <i class="fa-solid fa-photo-film"></i>
          </div>
          <h3>Current Media</h3>
        </div>
        <div class="current-media-section">
          <% if @fan.avatar.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Avatar</label>
              <div class="current-media-preview avatar-preview">
                <%= cl_image_tag @fan.avatar.key, class: "avatar-image-preview" %>
              </div>
            </div>
          <% end %>

          <% if @fan.banner.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Banner</label>
              <div class="current-media-preview banner-preview">
                <%= cl_image_tag @fan.banner.key, class: "banner-image-preview" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Favorite Artists Section %>
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-heart"></i>
        </div>
        <h3>Favorite Artists</h3>
      </div>
      <div style="padding: 20px;">
        <p style="color: #888; font-size: 0.85rem; margin: 0 0 16px 0;">
          Your favorite artists are based on who you follow.
          <%= link_to "Browse musicians", musicians_path, style: "color: #C8E938;" %> to follow more!
        </p>
        <% if @fan.user.followed_musicians.any? %>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            <% @fan.user.followed_musicians.each do |musician| %>
              <%= link_to musician_path(musician), style: "text-decoration: none;" do %>
                <div style="display: flex; align-items: center; gap: 10px; background: #252525; padding: 10px 14px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='#252525'">
                  <div style="width: 36px; height: 36px; border-radius: 50%; background: #C8E938; display: flex; align-items: center; justify-content: center; color: #171717; font-weight: 600; font-size: 0.8rem; overflow: hidden;">
                    <% if musician.avatar.attached? %>
                      <%= cl_image_tag(musician.avatar.key, style: "width: 100%; height: 100%; object-fit: cover;") %>
                    <% else %>
                      <%= musician.name.split.map(&:first).join.upcase[0..1] %>
                    <% end %>
                  </div>
                  <span style="color: #fff; font-size: 0.85rem;"><%= musician.name %></span>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <div style="text-align: center; padding: 20px;">
            <i class="fa-solid fa-heart" style="font-size: 2rem; color: #333; margin-bottom: 8px;"></i>
            <p style="color: #666; margin: 0;">You're not following any musicians yet</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
