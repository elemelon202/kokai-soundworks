<div class="band-dashboard-container">
  <div class="band-dashboard-header">
    <h1><%= t('band.dashboard.title') %></h1>
    <h1> <%= @band.name %> </h1>
    <h2><%= t('band.dashboard.subtitle') %></h2>
    <%= link_to band_path(@band), class: "btn-view-band" do %>
      <i class="fa-solid fa-eye"></i> <%= t('band.dashboard.view_band_page') %>
    <% end %>
    <%= link_to band_kanban_tasks_path(@band), class: "btn-view-band" do %>
      <i class="fa-solid fa-list-check"></i> <%= t('band.dashboard.tasks') %>
    <% end %>
  </div>
  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>
  <div class="band-stats-grid">


    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @band.musicians.count %></div>
      <div class="stat-label"><%= t('band.stats.band_members') %></div>
      <div class="stat-sub"><%= t('band.stats.pending_invitations') %>: <%= @band.band_invitations.pending.count %></div>
    </div>

    <% if @next_gig %>
      <div class="band-stat-card countdown-card" data-controller="countdown" data-countdown-date-value="<%= @next_gig.date.to_datetime.iso8601 %>">
        <div class="stat-icon countdown-icon">
          <i class="fa-solid fa-clock"></i>
        </div>
        <div class="countdown-display">
          <div class="countdown-numbers" data-countdown-target="display">
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="days">--</span>
              <span class="countdown-label"><%= t('band.stats.countdown.days') %></span>
            </div>
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="hours">--</span>
              <span class="countdown-label"><%= t('band.stats.countdown.hours') %></span>
            </div>
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="minutes">--</span>
              <span class="countdown-label"><%= t('band.stats.countdown.minutes') %></span>
            </div>
          </div>
        </div>
        <div class="countdown-gig-name"><%= truncate(@next_gig.name, length: 25) %></div>
        <div class="countdown-venue"><%= @next_gig.venue_name %></div>
      </div>
    <% else %>
      <div class="band-stat-card">
        <div class="stat-icon">
          <i class="fa-solid fa-calendar-days"></i>
        </div>
        <div class="stat-value">0</div>
        <div class="stat-label"><%= t('band.stats.upcoming_gigs') %></div>
        <div class="stat-sub"><%= t('band.stats.book_a_gig') %></div>
      </div>
    <% end %>

    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-envelope"></i>
      </div>
      <div class="stat-value"><%= @unread_count %></div>
      <div class="stat-label"><%= t('band.stats.unread_messages') %></div>
    </div>
  </div>

  <%# Upcoming Gigs Section %>
  <div class="band-gigs-section">
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-calendar-alt"></i>
        </div>
        <h3><%= t('band.gigs.title') %></h3>
      </div>

      <div class="gigs-content">
        <%# Add Gig Form %>
        <div class="add-gig-form">
          <%= form_with model: [@band, BandGig.new], local: true, class: "gig-form" do |f| %>
            <div class="gig-form-row">
              <div class="gig-form-group">
                <%= f.text_field :name, placeholder: t('band.gigs.gig_name_placeholder'), class: "gig-input", required: true %>
              </div>
              <div class="gig-form-group">
                <%= f.text_field :venue_name, placeholder: t('band.gigs.venue_placeholder'), class: "gig-input" %>
              </div>
              <div class="gig-form-group">
                <%= f.date_field :date, class: "gig-input", required: true, min: Date.current %>
              </div>
              <div class="gig-form-group">
                <%= f.text_field :location, placeholder: t('band.gigs.location_placeholder'), class: "gig-input" %>
              </div>
              <%= f.submit t('band.gigs.add_gig'), class: "btn-add-gig" %>
            </div>
          <% end %>
        </div>

        <%# Gigs List %>
        <% upcoming_gigs = @band.band_gigs.upcoming %>
        <% if upcoming_gigs.any? %>
          <div class="gigs-list">
            <% upcoming_gigs.each do |gig| %>
              <div class="gig-item">
                <div class="gig-date">
                  <span class="gig-day"><%= gig.date.strftime("%d") %></span>
                  <span class="gig-month"><%= gig.date.strftime("%b") %></span>
                </div>
                <div class="gig-details">
                  <div class="gig-name"><%= gig.name %></div>
                  <div class="gig-venue">
                    <% if gig.venue_name.present? %>
                      <i class="fa-solid fa-location-dot"></i> <%= gig.venue_name %>
                      <% if gig.location.present? %>
                        <span class="gig-location">(<%= gig.location %>)</span>
                      <% end %>
                    <% elsif gig.location.present? %>
                      <i class="fa-solid fa-location-dot"></i> <%= gig.location %>
                    <% end %>
                  </div>
                </div>
                <div class="gig-countdown-mini">
                  <% days_until = (gig.date - Date.current).to_i %>
                  <span class="days-count"><%= days_until %></span>
                  <span class="days-label"><%= days_until == 1 ? t('band.gigs.day') : t('band.gigs.days') %></span>
                </div>
                <%= button_to band_band_gig_path(@band, gig), method: :delete, class: "gig-delete", data: { turbo_confirm: t('band.gigs.remove_confirm') } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="gigs-empty">
            <i class="fa-solid fa-guitar"></i>
            <p><%= t('band.gigs.no_gigs') %></p>
            <p class="sub"><%= t('band.gigs.add_gig_hint') %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Funded Gig Applications Section %>
  <div class="band-funded-gigs-section">
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-hand-holding-heart"></i>
        </div>
        <h3><%= t('band.funded_shows.title') %></h3>
        <%= link_to funded_gigs_path, class: "band-feed-note" do %>
          <i class="fa-solid fa-search"></i> <%= t('band.funded_shows.browse_opportunities') %>
        <% end %>
      </div>

      <div class="funded-gigs-content">
        <% pending_apps = @band.gig_applications.pending.includes(gig: [:venue, :funded_gig]).select { |app| app.gig.funded? } %>
        <% approved_apps = @band.gig_applications.approved.includes(gig: [:venue, :funded_gig]).select { |app| app.gig.funded? } %>
        <% rejected_apps = @band.gig_applications.rejected.includes(gig: [:venue, :funded_gig]).select { |app| app.gig.funded? }.last(3) %>

        <% if pending_apps.any? || approved_apps.any? %>
          <% if approved_apps.any? %>
            <div class="funded-app-section mb-3">
              <h5 class="funded-app-title"><i class="fa-solid fa-check-circle text-success me-2"></i><%= t('band.funded_shows.approved') %></h5>
              <% approved_apps.each do |app| %>
                <div class="funded-app-item approved">
                  <div class="funded-app-info">
                    <strong><%= app.gig.name %></strong>
                    <span class="text-muted">@ <%= app.gig.venue.name %></span>
                    <span class="text-muted"><%= app.gig.date.strftime("%b %d, %Y") %></span>
                  </div>
                  <div class="funded-app-status">
                    <% if app.gig.funded_gig.accepting_pledges? %>
                      <span class="badge bg-primary"><%= app.gig.funded_gig.funding_percentage %>% funded</span>
                    <% elsif app.gig.funded_gig.funded? || app.gig.funded_gig.completed? %>
                      <span class="badge bg-success"><%= t('band.funded_shows.funded') %></span>
                    <% end %>
                  </div>
                  <%= link_to funded_gig_path(app.gig.funded_gig), class: "btn-view-funded-gig" do %>
                    <i class="fa-solid fa-eye"></i>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if pending_apps.any? %>
            <div class="funded-app-section mb-3">
              <h5 class="funded-app-title"><i class="fa-solid fa-clock text-warning me-2"></i><%= t('band.funded_shows.pending_review') %></h5>
              <% pending_apps.each do |app| %>
                <div class="funded-app-item pending">
                  <div class="funded-app-info">
                    <strong><%= app.gig.name %></strong>
                    <span class="text-muted">@ <%= app.gig.venue.name %></span>
                    <span class="text-muted"><%= app.gig.date.strftime("%b %d, %Y") %></span>
                  </div>
                  <div class="funded-app-status">
                    <span class="badge bg-warning text-dark"><%= t('band.funded_shows.pending') %></span>
                  </div>
                  <%= link_to funded_gig_path(app.gig.funded_gig), class: "btn-view-funded-gig" do %>
                    <i class="fa-solid fa-eye"></i>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if rejected_apps.any? %>
            <div class="funded-app-section">
              <h5 class="funded-app-title"><i class="fa-solid fa-times-circle text-secondary me-2"></i><%= t('band.funded_shows.not_selected') %></h5>
              <% rejected_apps.each do |app| %>
                <div class="funded-app-item rejected">
                  <div class="funded-app-info">
                    <strong><%= app.gig.name %></strong>
                    <span class="text-muted">@ <%= app.gig.venue.name %></span>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div class="funded-gigs-empty">
            <i class="fa-solid fa-hand-holding-heart"></i>
            <p><%= t('band.funded_shows.no_applications') %></p>
            <p class="sub">
              <%= link_to t('band.funded_shows.browse_opportunities'), funded_gigs_path %> <%= t('band.funded_shows.browse_hint').split(t('band.funded_shows.browse_opportunities')).last %>
            </p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Analytics Section %>
  <div class="band-analytics-section">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-chart-line"></i>
        </div>
        <h3><%= t('band.analytics.title') %></h3>
        <span class="analytics-private-note"><%= t('band.analytics.private_note') %></span>
      </div>
      <% if @stats.present? %>
        <div class="band-stats-grid band-feed-section">
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-user-plus"></i>
            </div>
            <div class="stat-value"><%= @stats[:followers_count] %></div>
            <div class="stat-label"><%= t('band.analytics.followers') %></div>
            <% if @stats[:new_followers_week] > 0 %>
              <div class="stat-sub analytics-stat-positive">+<%= @stats[:new_followers_week] %> <%= t('band.analytics.this_week') %></div>
            <% end %>
          </div>
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-eye"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_views_week] %></div>
            <div class="stat-label"><%= t('band.analytics.views_this_week') %></div>
            <div class="stat-sub"><%= @stats[:profile_views_total] %> <%= t('band.analytics.total') %></div>
          </div>
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-bookmark"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_saves] %></div>
            <div class="stat-label"><%= t('band.analytics.profile_saves') %></div>
          </div>
          <% if @stats[:mainstage_wins] > 0 %>
            <div class="band-stat-card">
              <div class="stat-icon stat-icon-trophy">
                <i class="fa-solid fa-trophy"></i>
              </div>
              <div class="stat-value stat-value-trophy"><%= @stats[:mainstage_wins] %></div>
              <div class="stat-label"><%= t('band.analytics.mainstage_wins') %></div>
            </div>
          <% end %>
        </div>
        <%# Current MAINSTAGE Stats %>
        <div class="band-mainstage-stats">
          <div class="band-mainstage-header">
            <i class="fa-solid fa-fire"></i>
            <span><%= t('band.analytics.current_mainstage') %></span>
            <% if @stats[:mainstage_rank] %>
              <span class="mainstage-rank-badge"><%= t('band.analytics.rank') %> #<%= @stats[:mainstage_rank] %></span>
            <% end %>
          </div>
          <div class="band-mainstage-scores">
            <div class="band-mainstage-score-card">
              <div class="score-value engagement"><%= @stats[:mainstage_engagement] %></div>
              <div class="score-label"><%= t('band.analytics.engagement') %></div>
            </div>
            <div class="band-mainstage-score-card">
              <div class="score-value votes"><%= @stats[:mainstage_votes] %></div>
              <div class="score-label"><%= t('band.analytics.votes') %></div>
            </div>
            <div class="band-mainstage-score-card">
              <div class="score-value total"><%= @stats[:mainstage_total] %></div>
              <div class="score-label"><%= t('band.analytics.total_score') %></div>
            </div>
          </div>
          <%= link_to band_mainstage_path, class: "band-mainstage-link" do %>
            <%= t('band.analytics.view_leaderboard') %> <i class="fa-solid fa-arrow-right"></i>
          <% end %>
        </div>

        <%# Growth Trends Section %>
        <div class="band-growth-trends">
          <div class="growth-trends-header">
            <i class="fa-solid fa-arrow-trend-up"></i>
            <span><%= t('band.analytics.growth_trends') %></span>
          </div>
          <div class="growth-trends-grid">
            <%# Kokai Platform Metrics %>
            <div class="growth-trend-item">
              <div class="growth-metric-name">
                <i class="fa-solid fa-user-plus"></i> <%= t('band.analytics.followers') %>
              </div>
              <% follower_growth = @stats[:new_followers_week] %>
              <% follower_pct = @stats[:followers_count] > 0 ? ((follower_growth.to_f / @stats[:followers_count]) * 100).round(1) : 0 %>
              <div class="growth-value <%= follower_growth > 0 ? 'positive' : (follower_growth < 0 ? 'negative' : 'neutral') %>">
                <% if follower_growth > 0 %>
                  <i class="fa-solid fa-arrow-up"></i> +<%= follower_pct %>%
                <% elsif follower_growth < 0 %>
                  <i class="fa-solid fa-arrow-down"></i> <%= follower_pct %>%
                <% else %>
                  <i class="fa-solid fa-minus"></i> 0%
                <% end %>
              </div>
              <div class="growth-detail"><%= follower_growth > 0 ? "+#{follower_growth}" : follower_growth %> <%= t('band.analytics.this_week') %></div>
            </div>

            <div class="growth-trend-item">
              <div class="growth-metric-name">
                <i class="fa-solid fa-eye"></i> <%= t('band.analytics.profile_views') %>
              </div>
              <% views_week = @stats[:profile_views_week] %>
              <% views_total = @stats[:profile_views_total] %>
              <% views_pct = views_total > views_week && views_total > 0 ? ((views_week.to_f / (views_total - views_week).to_f) * 100).round(1) : 0 %>
              <div class="growth-value <%= views_week > 0 ? 'positive' : 'neutral' %>">
                <% if views_week > 0 %>
                  <i class="fa-solid fa-arrow-up"></i> +<%= views_pct > 100 ? '>100' : views_pct %>%
                <% else %>
                  <i class="fa-solid fa-minus"></i> 0%
                <% end %>
              </div>
              <div class="growth-detail"><%= views_week %> <%= t('band.analytics.views_this_week_detail') %></div>
            </div>

            <%# Social Media Trends %>
            <% social_platforms = [
              { name: 'Instagram', icon: 'fa-instagram', brand: true, followers: @band.instagram_followers.to_i, handle: @band.instagram_handle },
              { name: 'TikTok', icon: 'fa-tiktok', brand: true, followers: @band.tiktok_followers.to_i, handle: @band.tiktok_handle },
              { name: 'YouTube', icon: 'fa-youtube', brand: true, followers: @band.youtube_subscribers.to_i, handle: @band.youtube_handle },
              { name: 'X', icon: 'fa-x-twitter', brand: true, followers: @band.twitter_followers.to_i, handle: @band.twitter_handle }
            ] %>
            <% social_platforms.each do |platform| %>
              <% next if platform[:followers] == 0 && platform[:handle].blank? %>
              <div class="growth-trend-item social-trend <%= platform[:name].downcase %>">
                <div class="growth-metric-name">
                  <i class="fa-brands <%= platform[:icon] %>"></i> <%= platform[:name] %>
                </div>
                <div class="growth-value neutral">
                  <span class="social-follower-count"><%= number_with_delimiter(platform[:followers]) %></span>
                </div>
                <div class="growth-detail">
                  <% if platform[:handle].present? %>
                    <%= platform[:handle] %>
                  <% else %>
                    <%= t('band.analytics.add_handle_to_track') %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>

          <%# Total Reach Summary %>
          <% total_social = @band.instagram_followers.to_i + @band.tiktok_followers.to_i + @band.youtube_subscribers.to_i + @band.twitter_followers.to_i %>
          <% if total_social > 0 %>
            <div class="growth-total-reach">
              <div class="reach-icon"><i class="fa-solid fa-globe"></i></div>
              <div class="reach-content">
                <span class="reach-label"><%= t('band.analytics.total_social_reach') %></span>
                <span class="reach-number"><%= number_with_delimiter(total_social) %></span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="band-analytics-empty">
          <i class="fa-solid fa-chart-line"></i>
          <p><%= t('band.analytics.no_data') %></p>
        </div>
      <% end %>
    </div>
  </div>
  <%# SOCIAL MEDIA TRACKING SECTION - COMMENTED OUT FOR NOW %>
  <% if false # Remove 'if false' to re-enable this section %>
  <!-- Social Media Tracking Section -->
  <div class="band-social-section">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-chart-simple"></i>
        </div>
        <h3>Social Media Tracking</h3>
        <span class="analytics-private-note">Track your growth across platforms</span>
      </div>
      <div class="social-tracking-section">
        <%= form_with model: @band, local: true, class: "social-tracking-form" do |f| %>
          <div class="social-stats-grid">
            <%# Instagram %>
            <div class="social-stat-card instagram">
              <div class="social-stat-header">
                <i class="fa-brands fa-instagram"></i>
                <span>Instagram</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :instagram_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :instagram_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.instagram_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.instagram_followers) %></span>
                </div>
              <% end %>
            </div>

            <%# TikTok %>
            <div class="social-stat-card tiktok">
              <div class="social-stat-header">
                <i class="fa-brands fa-tiktok"></i>
                <span>TikTok</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :tiktok_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :tiktok_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.tiktok_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.tiktok_followers) %></span>
                </div>
              <% end %>
            </div>

            <%# YouTube %>
            <div class="social-stat-card youtube">
              <div class="social-stat-header">
                <i class="fa-brands fa-youtube"></i>
                <span>YouTube</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :youtube_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :youtube_subscribers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">subscribers</span>
                </div>
              </div>
              <% if @band.youtube_subscribers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.youtube_subscribers) %></span>
                </div>
              <% end %>
            </div>

            <%# Twitter/X %>
            <div class="social-stat-card twitter">
              <div class="social-stat-header">
                <i class="fa-brands fa-x-twitter"></i>
                <span>X / Twitter</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :twitter_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :twitter_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.twitter_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.twitter_followers) %></span>
                </div>
              <% end %>
            </div>
          </div>

          <div class="social-tracking-total">
            <% total_followers = (@band.instagram_followers.to_i + @band.tiktok_followers.to_i + @band.youtube_subscribers.to_i + @band.twitter_followers.to_i) %>
            <div class="total-reach">
              <span class="total-label">Total Reach</span>
              <span class="total-number"><%= number_with_delimiter(total_followers) %></span>
            </div>
          </div>

          <div class="social-tracking-submit">
            <%= f.submit "Save Social Stats", class: "btn-save-social" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <% end # END SOCIAL MEDIA TRACKING SECTION %>

  <%# Band Calendar Section %>
  <%# Build calendar data first so we can use it in the controller wrapper %>
  <%
    gigs_data = @band.gigs.map do |gig|
      {
        id: gig.id,
        name: gig.name,
        date: gig.date,
        start_time: gig.start_time&.strftime("%H:%M"),
        end_time: gig.end_time&.strftime("%H:%M"),
        venue: gig.venue&.name,
        url: gig_path(gig)
      }
    end

    band_events_data = @band.band_events.map do |event|
      {
        id: event.id,
        title: event.title,
        date: event.date,
        event_type: event.event_type,
        start_time: event.start_time&.strftime("%H:%M"),
        end_time: event.end_time&.strftime("%H:%M"),
        location: event.location,
        description: event.description
      }
    end

    availabilities_data = @band.member_availabilities.includes(:musician).map do |avail|
      {
        id: avail.id,
        start_date: avail.start_date,
        end_date: avail.end_date,
        status: avail.status,
        reason: avail.notes,
        musician_id: avail.musician_id,
        musician_name: avail.musician&.name
      }
    end
  %>
  <div class="band-calendar-section"
       data-controller="band-calendar"
       data-band-calendar-gigs-value="<%= gigs_data.to_json %>"
       data-band-calendar-band-events-value="<%= band_events_data.to_json %>"
       data-band-calendar-availabilities-value="<%= availabilities_data.to_json %>"
       data-band-calendar-band-id-value="<%= @band.id %>"
       data-band-calendar-is-leader-value="<%= @band.user_id == current_user.id %>">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon card-icon-calendar">
          <i class="fa-solid fa-calendar-days"></i>
        </div>
        <h3><%= t('band.calendar.title') %></h3>
        <% if @band.user_id == current_user.id %>
          <button type="button" class="btn-add-event" data-action="click->band-calendar#showAddEventForm">
            <i class="fa-solid fa-plus"></i> <%= t('band.calendar.add_event') %>
          </button>
        <% end %>
      </div>
      <%# Calendar Legend %>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color" style="background: #fbbf24;"></span>
          <span><%= t('band.calendar.legend.gigs') %></span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #C8E938;"></span>
          <span><%= t('band.calendar.legend.rehearsals') %></span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #60a5fa;"></span>
          <span><%= t('band.calendar.legend.meetings') %></span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #E936AD;"></span>
          <span><%= t('band.calendar.legend.recording') %></span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #ef4444;"></span>
          <span><%= t('band.calendar.legend.unavailable') %></span>
        </div>
      </div>
      <div class="band-calendar-wrapper">
        <div data-band-calendar-target="calendar" class="band-calendar"></div>
        <%# Event Details Modal %>
        <div data-band-calendar-target="modal" class="calendar-modal" style="display: none;">
          <div class="calendar-modal-content">
            <button type="button" class="modal-close" data-action="click->band-calendar#closeModal">
              <i class="fa-solid fa-times"></i>
            </button>
            <h4 data-band-calendar-target="modalTitle"></h4>
            <div data-band-calendar-target="modalBody"></div>
          </div>
        </div>
        <%# Add Event Form (Leader only) %>
        <% if @band.user_id == current_user.id %>
          <div data-band-calendar-target="eventForm" class="calendar-event-form" style="display: none;">
            <h4><%= t('band.calendar.event_form.title') %></h4>
            <%= form_with model: BandEvent.new, url: band_band_events_path(@band), local: true, class: "event-form" do |f| %>
              <div class="form-group">
                <%= f.label :title, t('band.calendar.event_form.event_title') %>
                <%= f.text_field :title, class: "form-control", required: true %>
              </div>
              <div class="form-group">
                <%= f.label :event_type, t('band.calendar.event_form.event_type') %>
                <%= f.select :event_type, BandEvent.event_types.keys.map { |k| [t("band.calendar.event_types.#{k}"), k] }, {}, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= f.label :date, t('band.calendar.event_form.date') %>
                <%= f.date_field :date, class: "form-control", required: true %>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <%= f.label :start_time, t('band.calendar.event_form.start_time') %>
                  <%= f.time_field :start_time, class: "form-control" %>
                </div>
                <div class="form-group">
                  <%= f.label :end_time, t('band.calendar.event_form.end_time') %>
                  <%= f.time_field :end_time, class: "form-control" %>
                </div>
              </div>
              <div class="form-group">
                <%= f.label :location, t('band.calendar.event_form.location') %>
                <%= f.text_field :location, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= f.label :description, t('band.calendar.event_form.description') %>
                <%= f.text_area :description, class: "form-control", rows: 3 %>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" data-action="click->band-calendar#closeEventForm"><%= t('band.calendar.event_form.cancel') %></button>
                <%= f.submit t('band.calendar.event_form.submit'), class: "btn-submit" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <%# Member Availability Section %>
      <div class="member-availability-section">
        <h4><i class="fa-solid fa-user-clock"></i> <%= t('band.calendar.availability.title') %></h4>
        <p class="availability-hint"><%= t('band.calendar.availability.hint') %></p>
        <%= form_with model: MemberAvailability.new, url: band_member_availabilities_path(@band), local: true, class: "availability-form" do |f| %>
          <div class="availability-form-row">
            <div class="form-group">
              <%= f.label :start_date, t('band.calendar.availability.from'), class: "availability-label" %>
              <%= f.date_field :start_date, class: "form-control", required: true, min: Date.today %>
            </div>
            <div class="form-group">
              <%= f.label :end_date, t('band.calendar.availability.to_optional'), class: "availability-label" %>
              <%= f.date_field :end_date, class: "form-control", min: Date.today %>
            </div>
            <div class="form-group">
              <%# MemberAvailability.statuses.keys returns ["unavailable", "tentative"]
                  .map { |k| [k.titleize, k] } transforms it to [["Unavailable", "unavailable"], ["Tentative", "tentative"]]
                  This gives users a nice display name while submitting the lowercase value to the database %>
              <%= f.select :status, MemberAvailability.statuses.keys.map { |k| [t("band.calendar.availability.status.#{k}"), k] }, {}, class: "form-control" %>
            </div>
            <div class="form-group">
              <%= f.text_field :notes, class: "form-control", placeholder: t('band.calendar.availability.reason_placeholder') %>
            </div>
            <%= f.submit t('band.calendar.availability.submit'), class: "btn-unavailable" %>
          </div>
        <% end %>
        <%# Display current user's availabilities with delete option %>
        <% my_availabilities = @band.member_availabilities.where(musician: current_user.musician).order(:start_date) %>
        <div class="my-availabilities-list" id="my-availabilities-list">
        <% if my_availabilities.any? %>
            <h5><%= t('band.calendar.availability.your_unavailability') %></h5>
            <% my_availabilities.each do |avail| %>
              <div class="availability-item" id="availability_<%= avail.id %>">
                <div class="availability-info">
                  <span class="availability-dates">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    <%= avail.start_date.strftime("%b %d, %Y") %>
                    <% if avail.end_date.present? %>
                      - <%= avail.end_date.strftime("%b %d, %Y") %>
                    <% end %>
                  </span>
                  <span class="availability-status <%= avail.status %>"><%= t("band.calendar.availability.status.#{avail.status}") %></span>
                  <% if avail.notes.present? %>
                    <span class="availability-reason"><%= avail.notes %></span>
                  <% end %>
                </div>
                <%= button_to band_member_availability_path(@band, avail), method: :delete, class: "btn-delete-availability", data: { turbo_confirm: t('band.calendar.availability.remove_confirm') } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            <% end %>
        <% end %>
        </div>
      </div>
    </div>
  </div>
  <div class="band-dashboard-content">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-comments"></i>
        </div>
        <h3><%= t('band.chat.title') %></h3>
      </div>
      <div class="band-chat-wrapper">
        <%= render 'chat', band: @band %>
      </div>
    </div>

    <%# Musicians Wanted Section %>
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon card-icon-feed">
          <i class="fa-solid fa-bullhorn"></i>
        </div>
        <h3><%= t('band.musicians_wanted.title') %></h3>
        <%= link_to posts_path, class: "band-feed-note" do %>
          <i class="fa-solid fa-plus"></i> <%= t('band.musicians_wanted.post_new') %>
        <% end %>
      </div>
      <div class="band-feed-section">
        <% wanted_posts = @band.posts.where(active: true).where('needed_by >= ?', Date.current).recent.limit(5) %>
        <% if wanted_posts.any? %>
          <div class="band-posts-feed">
            <% wanted_posts.each do |post| %>
              <%= render "posts/post", post: post %>
            <% end %>
          </div>
        <% else %>
          <div class="band-empty-feed">
            <i class="fa-solid fa-bullhorn"></i>
            <p><%= t('band.musicians_wanted.no_posts') %></p>
            <p class="sub">
              <%= link_to t('band.musicians_wanted.post_new'), posts_path %> <%= t('band.musicians_wanted.post_hint').split(t('band.musicians_wanted.post_new')).last rescue '' %>
            </p>
          </div>
        <% end %>
      </div>
    </div>
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-plus"></i>
        </div>
        <h3><%= t('band.invite.title') %></h3>
      </div>
      <div class="band-invite-section">
        <turbo-frame id="band_invitation_form">
          <%= render partial: "bands/invite", locals: { band: @band, invitation: @band_invitation } %>
        </turbo-frame>
        <div class="mt-4">
          <%= render partial: "bands/pending_invitations", locals: { pending_invitations: @pending_invitations } %>
        </div>
      </div>
    </div>
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <h3><%= t('band.members.title') %></h3>
      </div>
      <div class="band-members-list">
        <% @band.musicians.each do |musician| %>
          <div class="band-member-item">
            <%= link_to musician_path(musician), class: "member-avatar-link" do %>
              <div class="member-avatar">
                <% if musician.banner.attached? %>
                  <%= image_tag url_for(musician.banner), class: "avatar-image" %>
                <% elsif musician.images.attached? %>
                  <%= image_tag url_for(musician.images.first), class: "avatar-image" %>
                <% else %>
                  <i class="fa-solid fa-user"></i>
                <% end %>
              </div>
            <% end %>
            <div class="member-details">
              <div class="member-name">
                <%= link_to musician.name, musician_path(musician) %>
                <% if musician.user_id == @band.user_id %>
                  <span class="leader-badge"><i class="fa-solid fa-crown"></i> <%= t('band.members.leader') %></span>
                <% end %>
              </div>
              <div class="member-info">
                <span class="member-instrument"><i class="fa-solid fa-guitar"></i> <%= musician.instrument || t('band.members.not_specified') %></span>
                <% if musician.location.present? %>
                  <span class="member-location"><i class="fa-solid fa-location-dot"></i> <%= musician.location %></span>
                <% end %>
              </div>
            </div>
            <div class="member-actions">
              <% if musician.user_id != current_user.id %>
                <%= button_to create_or_show_direct_messages_path(recipient_id: musician.user_id), method: :post, class: "btn-member-action", title: t('band.members.send_message') do %>
                  <i class="fa-solid fa-envelope"></i>
                <% end %>
              <% end %>
              <% if @band.user_id == current_user.id && musician.user_id != current_user.id %>
                <% involvement = Involvement.find_by(band: @band, musician: musician) %>
                <% if involvement %>
                  <%= button_to involvement_path(involvement), method: :delete, class: "btn-member-action danger", title: t('band.members.remove_from_band'), data: { turbo_confirm: t('band.members.remove_confirm', name: musician.name, band: @band.name) } do %>
                    <i class="fa-solid fa-user-minus"></i>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>



    <!-- Band Media Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-images"></i>
        </div>
        <h3><%= t('band.media.title') %></h3>
      </div>
      <!-- Current Media Display (only shows sections with content) -->
      <% if @band.banner.attached? || @band.images.attached? || @band.videos.attached? %>
        <div class="current-media-section">
          <h4 class="current-media-title"><i class="fa-solid fa-photo-film"></i> <%= t('band.media.current_media') %></h4>
          <% if @band.banner.attached? %>
            <div class="media-display-group">
              <label class="media-group-label"><%= t('band.media.banner') %></label>
              <div class="current-media-preview banner-preview">
                <%= image_tag url_for(@band.banner), class: "banner-image-preview" %>
                <%= button_to purge_attachment_band_path(@band, attachment_id: @band.banner.id),
                    method: :delete,
                    class: "btn-remove-media",
                    data: { turbo_confirm: t('band.media.remove_banner_confirm') } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            </div>
            <!-- Banner Position Adjuster -->
            <div class="media-display-group" data-controller="banner-position">
              <label class="media-group-label"><%= t('band.media.banner_position') %></label>
              <p class="banner-position-help"><%= t('band.media.banner_position_help') %></p>
              <div class="banner-position-adjuster">
                <div class="banner-position-preview" data-banner-position-target="preview">
                  <%= image_tag url_for(@band.banner),
                      data: { banner_position_target: "image" },
                      style: "object-position: center #{@band.banner_position || 50}%;" %>
                </div>
                <div class="banner-position-controls">
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveUp" title="Move up">
                    <i class="fa-solid fa-chevron-up"></i>
                  </button>
                  <span class="position-value" data-banner-position-target="value"><%= @band.banner_position || 50 %>%</span>
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveDown" title="Move down">
                    <i class="fa-solid fa-chevron-down"></i>
                  </button>
                </div>
              </div>
              <%= form_with model: @band, local: true, class: "banner-position-form", data: { banner_position_target: "form" } do |f| %>
                <%= f.hidden_field :banner_position, data: { banner_position_target: "input" }, value: @band.banner_position || 50 %>
                <%= f.submit t('band.media.save_position'), class: "btn-save-position" %>
              <% end %>
            </div>
          <% end %>
          <% if @band.images.attached? %>
            <div class="media-display-group">
              <label class="media-group-label"><%= t('band.media.photos') %> (<%= @band.images.count %>)</label>
              <div class="current-media-grid">
                <% @band.images.each do |image| %>
                  <div class="media-grid-item">
                    <%= image_tag url_for(image), class: "preview-image" %>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: image.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: t('band.media.remove_photo_confirm') } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @band.videos.attached? %>
            <div class="media-display-group">
              <label class="media-group-label"><%= t('band.media.videos') %> (<%= @band.videos.count %>)</label>
              <div class="current-media-grid videos-grid">
                <% @band.videos.each do |video| %>
                  <div class="media-grid-item video-item">
                    <video controls class="preview-video">
                      <source src="<%= url_for(video) %>" type="<%= video.content_type %>">
                    </video>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: video.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: t('band.media.remove_video_confirm') } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      <!-- Upload Form -->
      <%= form_with model: @band, local: true, class: "band-media-form", id: "band-media-form" do |f| %>
        <%# Hidden field for banner position - updated by Stimulus controller when position is adjusted %>
        <%= f.hidden_field :banner_position, id: "band-media-form-banner-position", value: @band.banner_position || 50 %>
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4><%= t('band.media.upload.title') %></h4>
              <p><%= t('band.media.upload.subtitle') %></p>
            </div>
          </div>
          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label"><%= t('band.media.upload.banner_label') %></label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @band.banner.attached? ? t('band.media.upload.replace_banner') : t('band.media.upload.choose_banner') %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label"><%= t('band.media.upload.photos_label') %></label>
              <div class="upload-input-wrapper">
                <%= f.file_field :images, accept: "image/*", multiple: true, class: "media-file-input", id: "images-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="images-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-camera"></i>
                  <span><%= t('band.media.upload.add_photos') %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label"><%= t('band.media.upload.videos_label') %></label>
              <div class="upload-input-wrapper">
                <%= f.file_field :videos, accept: "video/*", multiple: true, class: "media-file-input", id: "videos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="videos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-video"></i>
                  <span><%= t('band.media.upload.add_videos') %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
          <div class="media-submit-wrapper">
            <%= f.submit t('band.media.upload.save'), class: "btn-save-media" %>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Spotify Tracks Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-brands fa-spotify"></i>
        </div>
        <h3><%= t('band.spotify.title') %></h3>
      </div>
      <div class="spotify-tracks-section">
        <p class="spotify-description"><%= t('band.spotify.description') %></p>
        <div id="spotify-tracks">
          <%= render partial: 'spotify_tracks/editable_track', collection: @band.spotify_tracks, as: :track %>
        </div>
        <%= render 'spotify_tracks/form', band: @band %>
      </div>
    </div>

    <%# LINE Integration Section - Leader Only %>
    <% if @band.user_id == current_user.id %>
      <div class="band-dashboard-card full-width">
        <div class="band-card-header">
          <div class="card-icon card-icon-line">
            <i class="fa-brands fa-line"></i>
          </div>
          <h3><%= t('band.line.title') %></h3>
          <span class="band-feed-note"><%= t('band.line.subtitle') %></span>
        </div>
        <div class="line-integration-section">
          <% line_connection = @band.line_band_connections.where(active: true).or(@band.line_band_connections.pending).first %>

          <% if line_connection&.linked? %>
            <%# Connected State %>
            <div class="line-connection-status connected">
              <div class="line-status-icon">
                <i class="fa-solid fa-check-circle"></i>
              </div>
              <div class="line-status-info">
                <span class="line-status-text"><%= t('band.line.connected') %></span>
                <span class="line-status-date"><%= t('band.line.linked_ago', time: time_ago_in_words(line_connection.linked_at)) %></span>
              </div>
            </div>

            <div class="line-settings">
              <div class="line-setting-item">
                <div class="line-setting-info">
                  <span class="line-setting-label"><%= t('band.line.auto_create_events') %></span>
                  <span class="line-setting-desc"><%= t('band.line.auto_create_desc') %></span>
                </div>
                <%= button_to toggle_auto_create_band_line_band_connection_path(@band, line_connection),
                    method: :patch,
                    class: "line-toggle-btn #{line_connection.auto_create_events ? 'active' : ''}" do %>
                  <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                  </span>
                  <span class="toggle-label"><%= line_connection.auto_create_events ? t('band.line.on') : t('band.line.off') %></span>
                <% end %>
              </div>
            </div>

            <% pending_events = line_connection.line_pending_events.pending %>
            <% if pending_events.any? %>
              <div class="line-pending-events">
                <h4><i class="fa-solid fa-clock"></i> <%= t('band.line.pending_events') %> (<%= pending_events.count %>)</h4>
                <p class="line-pending-hint"><%= t('band.line.pending_hint') %></p>
                <div class="pending-events-list">
                  <% pending_events.limit(5).each do |event| %>
                    <div class="pending-event-item">
                      <div class="pending-event-info">
                        <span class="pending-event-type <%= event.event_type %>"><%= t("band.calendar.event_types.#{event.event_type}", default: event.event_type.titleize) %></span>
                        <span class="pending-event-title"><%= event.title || "Untitled" %></span>
                        <span class="pending-event-date"><%= event.date&.strftime("%b %d, %Y") %> <%= event.start_time&.strftime("%H:%M") %></span>
                      </div>
                      <div class="pending-event-actions">
                        <%# TODO: Add confirm/reject actions %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <div class="line-disconnect">
              <%= button_to band_line_band_connection_path(@band, line_connection),
                  method: :delete,
                  class: "btn-line-disconnect",
                  data: { turbo_confirm: t('band.line.disconnect_confirm') } do %>
                <i class="fa-solid fa-unlink"></i> <%= t('band.line.disconnect') %>
              <% end %>
            </div>

          <% elsif line_connection&.pending? %>
            <%# Pending Link Code State %>
            <div class="line-connection-status pending">
              <div class="line-status-icon">
                <i class="fa-solid fa-link"></i>
              </div>
              <div class="line-status-info">
                <span class="line-status-text"><%= t('band.line.waiting') %></span>
              </div>
            </div>

            <div class="line-link-code-section">
              <p class="line-link-instructions">
                <%= t('band.line.link_instructions') %>
              </p>
              <div class="line-link-code-display">
                <code class="line-link-code"><%= line_connection.link_code %></code>
                <button type="button" class="btn-copy-code" data-code="<%= line_connection.link_code %>" onclick="navigator.clipboard.writeText(this.dataset.code); this.innerHTML='<i class=\'fa-solid fa-check\'></i> <%= t('band.line.copied') %>';">
                  <i class="fa-solid fa-copy"></i> <%= t('band.line.copy') %>
                </button>
              </div>
              <div class="line-link-help">
                <p><strong><%= t('band.line.how_to_connect') %></strong></p>
                <ol>
                  <li><%= t('band.line.step1') %></li>
                  <li><%= t('band.line.step2', code: line_connection.link_code) %></li>
                  <li><%= t('band.line.step3') %></li>
                </ol>
              </div>
            </div>

            <div class="line-disconnect">
              <%= button_to band_line_band_connection_path(@band, line_connection),
                  method: :delete,
                  class: "btn-line-cancel" do %>
                <i class="fa-solid fa-times"></i> <%= t('band.line.cancel') %>
              <% end %>
            </div>

          <% else %>
            <%# Not Connected State %>
            <div class="line-not-connected">
              <div class="line-feature-list">
                <div class="line-feature">
                  <i class="fa-solid fa-comments"></i>
                  <span><%= t('band.line.not_connected.feature1') %></span>
                </div>
                <div class="line-feature">
                  <i class="fa-solid fa-calendar-plus"></i>
                  <span><%= t('band.line.not_connected.feature2') %></span>
                </div>
                <div class="line-feature">
                  <i class="fa-solid fa-user-clock"></i>
                  <span><%= t('band.line.not_connected.feature3') %></span>
                </div>
              </div>

              <%= button_to band_line_band_connections_path(@band),
                  method: :post,
                  class: "btn-line-connect" do %>
                <i class="fa-brands fa-line"></i> <%= t('band.line.connect') %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @band.user_id == current_user.id %>
      <% other_members = @band.musicians.where.not(user_id: current_user.id) %>
      <% if other_members.any? %>
        <div class="band-dashboard-card full-width">
          <div class="band-card-header">
            <div class="card-icon">
              <i class="fa-solid fa-crown"></i>
            </div>
            <h3><%= t('band.transfer.title') %></h3>
          </div>
          <div class="transfer-leadership-section">
            <p><%= t('band.transfer.description') %></p>
            <div class="transfer-form">
              <%= form_with url: transfer_leadership_band_path(@band), method: :patch, local: true do |f| %>
                <div class="transfer-input-group">
                  <div class="transfer-select-wrapper">
                    <%= f.label :musician_id, class: "transfer-label" do %>
                      <i class="fa-solid fa-user"></i> <%= t('band.transfer.select_label') %>
                    <% end %>
                    <%= f.collection_select :musician_id, other_members, :id, :name,
                        { prompt: t('band.transfer.select_prompt') },
                        { class: "transfer-select" } %>
                  </div>
                  <%= f.submit t('band.transfer.submit'), class: "btn-transfer",
                      data: { turbo_confirm: t('band.transfer.confirm') } %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      <div class="band-dashboard-card full-width leave-band-card">
        <div class="band-card-header">
          <div class="card-icon danger">
            <i class="fa-solid fa-trash"></i>
          </div>
          <h3><%= t('band.delete.title') %></h3>
        </div>
        <div class="leave-band-section">
          <p><%= t('band.delete.description') %></p>
          <%= button_to @band.name, band_path(@band),
              method: :delete,
              class: "btn-leave-band",
              data: { turbo_confirm: t('band.delete.confirm', band: @band.name) } %>
        </div>
      </div>
    <% elsif current_user.musician %>
      <% involvement = Involvement.find_by(band: @band, musician: current_user.musician) %>
      <% if involvement %>
        <div class="band-dashboard-card full-width leave-band-card">
          <div class="band-card-header">
            <div class="card-icon danger">
              <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h3><%= t('band.leave.title') %></h3>
          </div>
          <div class="leave-band-section">
            <p><%= t('band.leave.description') %></p>
            <%= button_to @band.name, involvement_path(involvement),
                method: :delete,
                class: "btn-leave-band",
                data: { turbo_confirm: t('band.leave.confirm', band: @band.name) } %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
