<div class="band-dashboard-container">
  <div class="band-dashboard-header">
    <h1>Band Dashboard:</h1>
    <h1> <%= @band.name %> </h1>
    <h2>Manage your band gig applications and members</h2>
    <%= link_to band_path(@band), class: "btn-view-band" do %>
      <i class="fa-solid fa-eye"></i> View Band Page
    <% end %>
    <%= link_to band_kanban_tasks_path(@band), class: "btn-view-band" do %>
      <i class="fa-solid fa-list-check"></i> Tasks
    <% end %>
  </div>
  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>
  <div class="band-stats-grid">


    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @band.musicians.count %></div>
      <div class="stat-label">Band Members</div>
      <div class="stat-sub">Pending invitations: <%= @band.band_invitations.pending.count %></div>
    </div>

    <% if @next_gig %>
      <div class="band-stat-card countdown-card" data-controller="countdown" data-countdown-date-value="<%= @next_gig.date.to_datetime.iso8601 %>">
        <div class="stat-icon countdown-icon">
          <i class="fa-solid fa-clock"></i>
        </div>
        <div class="countdown-display">
          <div class="countdown-numbers" data-countdown-target="display">
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="days">--</span>
              <span class="countdown-label">days</span>
            </div>
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="hours">--</span>
              <span class="countdown-label">hrs</span>
            </div>
            <div class="countdown-unit">
              <span class="countdown-value" data-countdown-target="minutes">--</span>
              <span class="countdown-label">min</span>
            </div>
          </div>
        </div>
        <div class="countdown-gig-name"><%= truncate(@next_gig.name, length: 25) %></div>
        <div class="countdown-venue"><%= @next_gig.venue_name %></div>
      </div>
    <% else %>
      <div class="band-stat-card">
        <div class="stat-icon">
          <i class="fa-solid fa-calendar-days"></i>
        </div>
        <div class="stat-value">0</div>
        <div class="stat-label">Upcoming Gigs</div>
        <div class="stat-sub">Book a gig!</div>
      </div>
    <% end %>

    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-envelope"></i>
      </div>
      <div class="stat-value"><%= @unread_count %></div>
      <div class="stat-label">Unread Messages</div>
    </div>
  </div>

  <%# Upcoming Gigs Section %>
  <div class="band-gigs-section">
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-calendar-alt"></i>
        </div>
        <h3>Upcoming Gigs</h3>
      </div>

      <div class="gigs-content">
        <%# Add Gig Form %>
        <div class="add-gig-form">
          <%= form_with model: [@band, BandGig.new], local: true, class: "gig-form" do |f| %>
            <div class="gig-form-row">
              <div class="gig-form-group">
                <%= f.text_field :name, placeholder: "Gig name *", class: "gig-input", required: true %>
              </div>
              <div class="gig-form-group">
                <%= f.text_field :venue_name, placeholder: "Venue name", class: "gig-input" %>
              </div>
              <div class="gig-form-group">
                <%= f.date_field :date, class: "gig-input", required: true, min: Date.current %>
              </div>
              <div class="gig-form-group">
                <%= f.text_field :location, placeholder: "Location", class: "gig-input" %>
              </div>
              <%= f.submit "Add Gig", class: "btn-add-gig" %>
            </div>
          <% end %>
        </div>

        <%# Gigs List %>
        <% upcoming_gigs = @band.band_gigs.upcoming %>
        <% if upcoming_gigs.any? %>
          <div class="gigs-list">
            <% upcoming_gigs.each do |gig| %>
              <div class="gig-item">
                <div class="gig-date">
                  <span class="gig-day"><%= gig.date.strftime("%d") %></span>
                  <span class="gig-month"><%= gig.date.strftime("%b") %></span>
                </div>
                <div class="gig-details">
                  <div class="gig-name"><%= gig.name %></div>
                  <div class="gig-venue">
                    <% if gig.venue_name.present? %>
                      <i class="fa-solid fa-location-dot"></i> <%= gig.venue_name %>
                      <% if gig.location.present? %>
                        <span class="gig-location">(<%= gig.location %>)</span>
                      <% end %>
                    <% elsif gig.location.present? %>
                      <i class="fa-solid fa-location-dot"></i> <%= gig.location %>
                    <% end %>
                  </div>
                </div>
                <div class="gig-countdown-mini">
                  <% days_until = (gig.date - Date.current).to_i %>
                  <span class="days-count"><%= days_until %></span>
                  <span class="days-label"><%= days_until == 1 ? 'day' : 'days' %></span>
                </div>
                <%= button_to band_band_gig_path(@band, gig), method: :delete, class: "gig-delete", data: { turbo_confirm: "Remove this gig?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="gigs-empty">
            <i class="fa-solid fa-guitar"></i>
            <p>No upcoming gigs scheduled</p>
            <p class="sub">Add your next show above!</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Analytics Section %>
  <div class="band-analytics-section">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-chart-line"></i>
        </div>
        <h3>Band Analytics</h3>
        <span class="analytics-private-note">Only band members can see this</span>
      </div>
      <% if @stats.present? %>
        <div class="band-stats-grid band-feed-section">
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-user-plus"></i>
            </div>
            <div class="stat-value"><%= @stats[:followers_count] %></div>
            <div class="stat-label">Followers</div>
            <% if @stats[:new_followers_week] > 0 %>
              <div class="stat-sub analytics-stat-positive">+<%= @stats[:new_followers_week] %> this week</div>
            <% end %>
          </div>
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-eye"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_views_week] %></div>
            <div class="stat-label">Views This Week</div>
            <div class="stat-sub"><%= @stats[:profile_views_total] %> total</div>
          </div>
          <div class="band-stat-card">
            <div class="stat-icon">
              <i class="fa-solid fa-bookmark"></i>
            </div>
            <div class="stat-value"><%= @stats[:profile_saves] %></div>
            <div class="stat-label">Profile Saves</div>
          </div>
          <% if @stats[:mainstage_wins] > 0 %>
            <div class="band-stat-card">
              <div class="stat-icon stat-icon-trophy">
                <i class="fa-solid fa-trophy"></i>
              </div>
              <div class="stat-value stat-value-trophy"><%= @stats[:mainstage_wins] %></div>
              <div class="stat-label">MAINSTAGE Wins</div>
            </div>
          <% end %>
        </div>
        <%# Current MAINSTAGE Stats %>
        <div class="band-mainstage-stats">
          <div class="band-mainstage-header">
            <i class="fa-solid fa-fire"></i>
            <span>Current MAINSTAGE</span>
            <% if @stats[:mainstage_rank] %>
              <span class="mainstage-rank-badge">Rank #<%= @stats[:mainstage_rank] %></span>
            <% end %>
          </div>
          <div class="band-mainstage-scores">
            <div class="band-mainstage-score-card">
              <div class="score-value engagement"><%= @stats[:mainstage_engagement] %></div>
              <div class="score-label">Engagement</div>
            </div>
            <div class="band-mainstage-score-card">
              <div class="score-value votes"><%= @stats[:mainstage_votes] %></div>
              <div class="score-label">Votes</div>
            </div>
            <div class="band-mainstage-score-card">
              <div class="score-value total"><%= @stats[:mainstage_total] %></div>
              <div class="score-label">Total Score</div>
            </div>
          </div>
          <%= link_to band_mainstage_path, class: "band-mainstage-link" do %>
            View Full Leaderboard <i class="fa-solid fa-arrow-right"></i>
          <% end %>
        </div>

        <%# Growth Trends Section %>
        <div class="band-growth-trends">
          <div class="growth-trends-header">
            <i class="fa-solid fa-arrow-trend-up"></i>
            <span>Growth Trends</span>
          </div>
          <div class="growth-trends-grid">
            <%# Kokai Platform Metrics %>
            <div class="growth-trend-item">
              <div class="growth-metric-name">
                <i class="fa-solid fa-user-plus"></i> Followers
              </div>
              <% follower_growth = @stats[:new_followers_week] %>
              <% follower_pct = @stats[:followers_count] > 0 ? ((follower_growth.to_f / @stats[:followers_count]) * 100).round(1) : 0 %>
              <div class="growth-value <%= follower_growth > 0 ? 'positive' : (follower_growth < 0 ? 'negative' : 'neutral') %>">
                <% if follower_growth > 0 %>
                  <i class="fa-solid fa-arrow-up"></i> +<%= follower_pct %>%
                <% elsif follower_growth < 0 %>
                  <i class="fa-solid fa-arrow-down"></i> <%= follower_pct %>%
                <% else %>
                  <i class="fa-solid fa-minus"></i> 0%
                <% end %>
              </div>
              <div class="growth-detail"><%= follower_growth > 0 ? "+#{follower_growth}" : follower_growth %> this week</div>
            </div>

            <div class="growth-trend-item">
              <div class="growth-metric-name">
                <i class="fa-solid fa-eye"></i> Profile Views
              </div>
              <% views_week = @stats[:profile_views_week] %>
              <% views_total = @stats[:profile_views_total] %>
              <% views_pct = views_total > views_week && views_total > 0 ? ((views_week.to_f / (views_total - views_week).to_f) * 100).round(1) : 0 %>
              <div class="growth-value <%= views_week > 0 ? 'positive' : 'neutral' %>">
                <% if views_week > 0 %>
                  <i class="fa-solid fa-arrow-up"></i> +<%= views_pct > 100 ? '>100' : views_pct %>%
                <% else %>
                  <i class="fa-solid fa-minus"></i> 0%
                <% end %>
              </div>
              <div class="growth-detail"><%= views_week %> views this week</div>
            </div>

            <%# Social Media Trends %>
            <% social_platforms = [
              { name: 'Instagram', icon: 'fa-instagram', brand: true, followers: @band.instagram_followers.to_i, handle: @band.instagram_handle },
              { name: 'TikTok', icon: 'fa-tiktok', brand: true, followers: @band.tiktok_followers.to_i, handle: @band.tiktok_handle },
              { name: 'YouTube', icon: 'fa-youtube', brand: true, followers: @band.youtube_subscribers.to_i, handle: @band.youtube_handle },
              { name: 'X', icon: 'fa-x-twitter', brand: true, followers: @band.twitter_followers.to_i, handle: @band.twitter_handle }
            ] %>
            <% social_platforms.each do |platform| %>
              <% next if platform[:followers] == 0 && platform[:handle].blank? %>
              <div class="growth-trend-item social-trend <%= platform[:name].downcase %>">
                <div class="growth-metric-name">
                  <i class="fa-brands <%= platform[:icon] %>"></i> <%= platform[:name] %>
                </div>
                <div class="growth-value neutral">
                  <span class="social-follower-count"><%= number_with_delimiter(platform[:followers]) %></span>
                </div>
                <div class="growth-detail">
                  <% if platform[:handle].present? %>
                    <%= platform[:handle] %>
                  <% else %>
                    Add handle to track
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>

          <%# Total Reach Summary %>
          <% total_social = @band.instagram_followers.to_i + @band.tiktok_followers.to_i + @band.youtube_subscribers.to_i + @band.twitter_followers.to_i %>
          <% if total_social > 0 %>
            <div class="growth-total-reach">
              <div class="reach-icon"><i class="fa-solid fa-globe"></i></div>
              <div class="reach-content">
                <span class="reach-label">Total Social Reach</span>
                <span class="reach-number"><%= number_with_delimiter(total_social) %></span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="band-analytics-empty">
          <i class="fa-solid fa-chart-line"></i>
          <p>No analytics data yet</p>
        </div>
      <% end %>
    </div>
  </div>
  <%# Band Calendar Section %>
  <div class="band-calendar-section">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon card-icon-calendar">
          <i class="fa-solid fa-calendar-days"></i>
        </div>
        <h3>Band Calendar</h3>
        <% if @band.user_id == current_user.id %>
          <button type="button" class="btn-add-event" data-action="click->band-calendar#showAddEventForm">
            <i class="fa-solid fa-plus"></i> Add Event
          </button>
        <% end %>
      </div>
      <%# Calendar Legend %>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color" style="background: #fbbf24;"></span>
          <span>Gigs</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #C8E938;"></span>
          <span>Rehearsals</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #60a5fa;"></span>
          <span>Meetings</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #E936AD;"></span>
          <span>Recording</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #ef4444;"></span>
          <span>Unavailable</span>
        </div>
      </div>
      <%# Build calendar data %>
      <%
        gigs_data = @band.gigs.map do |gig|
          {
            id: gig.id,
            name: gig.name,
            date: gig.date,
            start_time: gig.start_time&.strftime("%H:%M"),
            end_time: gig.end_time&.strftime("%H:%M"),
            venue: gig.venue&.name,
            url: gig_path(gig)
          }
        end

        band_events_data = @band.band_events.map do |event|
          {
            id: event.id,
            title: event.title,
            date: event.date,
            event_type: event.event_type,
            start_time: event.start_time&.strftime("%H:%M"),
            end_time: event.end_time&.strftime("%H:%M"),
            location: event.location,
            description: event.description
          }
        end

        availabilities_data = @band.member_availabilities.includes(:musician).map do |avail|
          {
            id: avail.id,
            start_date: avail.start_date,
            end_date: avail.end_date,
            status: avail.status,
            reason: avail.notes,
            musician_id: avail.musician_id,
            musician_name: avail.musician&.name
          }
        end
      %>
      <div class="band-calendar-wrapper"
           data-controller="band-calendar"
           data-band-calendar-gigs-value="<%= gigs_data.to_json %>"
           data-band-calendar-band-events-value="<%= band_events_data.to_json %>"
           data-band-calendar-availabilities-value="<%= availabilities_data.to_json %>"
           data-band-calendar-band-id-value="<%= @band.id %>"
           data-band-calendar-is-leader-value="<%= @band.user_id == current_user.id %>">
        <div data-band-calendar-target="calendar" class="band-calendar"></div>
        <%# Event Details Modal %>
        <div data-band-calendar-target="modal" class="calendar-modal" style="display: none;">
          <div class="calendar-modal-content">
            <button type="button" class="modal-close" data-action="click->band-calendar#closeModal">
              <i class="fa-solid fa-times"></i>
            </button>
            <h4 data-band-calendar-target="modalTitle"></h4>
            <div data-band-calendar-target="modalBody"></div>
          </div>
        </div>
        <%# Add Event Form (Leader only) %>
        <% if @band.user_id == current_user.id %>
          <div data-band-calendar-target="eventForm" class="calendar-event-form" style="display: none;">
            <h4>Add Band Event</h4>
            <%= form_with model: BandEvent.new, url: band_band_events_path(@band), local: true, class: "event-form" do |f| %>
              <div class="form-group">
                <%= f.label :title %>
                <%= f.text_field :title, class: "form-control", required: true %>
              </div>
              <div class="form-group">
                <%= f.label :event_type %>
                <%= f.select :event_type, BandEvent.event_types.keys.map { |k| [k.titleize, k] }, {}, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= f.label :date %>
                <%= f.date_field :date, class: "form-control", required: true %>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <%= f.label :start_time %>
                  <%= f.time_field :start_time, class: "form-control" %>
                </div>
                <div class="form-group">
                  <%= f.label :end_time %>
                  <%= f.time_field :end_time, class: "form-control" %>
                </div>
              </div>
              <div class="form-group">
                <%= f.label :location %>
                <%= f.text_field :location, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= f.label :description %>
                <%= f.text_area :description, class: "form-control", rows: 3 %>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" data-action="click->band-calendar#closeEventForm">Cancel</button>
                <%= f.submit "Add Event", class: "btn-submit" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <%# Member Availability Section %>
      <div class="member-availability-section">
        <h4><i class="fa-solid fa-user-clock"></i> My Availability</h4>
        <p class="availability-hint">Mark dates when you're unavailable for band activities</p>
        <%= form_with model: MemberAvailability.new, url: band_member_availabilities_path(@band), local: true, class: "availability-form" do |f| %>
          <div class="availability-form-row">
            <div class="form-group">
              <%= f.label :start_date, "From", class: "availability-label" %>
              <%= f.date_field :start_date, class: "form-control", required: true, min: Date.today %>
            </div>
            <div class="form-group">
              <%= f.label :end_date, "To (optional)", class: "availability-label" %>
              <%= f.date_field :end_date, class: "form-control", min: Date.today %>
            </div>
            <div class="form-group">
              <%# MemberAvailability.statuses.keys returns ["unavailable", "tentative"]
                  .map { |k| [k.titleize, k] } transforms it to [["Unavailable", "unavailable"], ["Tentative", "tentative"]]
                  This gives users a nice display name while submitting the lowercase value to the database %>
              <%= f.select :status, MemberAvailability.statuses.keys.map { |k| [k.titleize, k] }, {}, class: "form-control" %>
            </div>
            <div class="form-group">
              <%= f.text_field :notes, class: "form-control", placeholder: "Reason (optional)" %>
            </div>
            <%= f.submit "Mark Unavailable", class: "btn-unavailable" %>
          </div>
        <% end %>
        <%# Display current user's availabilities with delete option %>
        <% my_availabilities = @band.member_availabilities.where(musician: current_user.musician).order(:start_date) %>
        <div class="my-availabilities-list" id="my-availabilities-list">
        <% if my_availabilities.any? %>
            <h5>Your Unavailability</h5>
            <% my_availabilities.each do |avail| %>
              <div class="availability-item" id="availability_<%= avail.id %>">
                <div class="availability-info">
                  <span class="availability-dates">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    <%= avail.start_date.strftime("%b %d, %Y") %>
                    <% if avail.end_date.present? %>
                      - <%= avail.end_date.strftime("%b %d, %Y") %>
                    <% end %>
                  </span>
                  <span class="availability-status <%= avail.status %>"><%= avail.status.titleize %></span>
                  <% if avail.notes.present? %>
                    <span class="availability-reason"><%= avail.notes %></span>
                  <% end %>
                </div>
                <%= button_to band_member_availability_path(@band, avail), method: :delete, class: "btn-delete-availability", data: { turbo_confirm: "Remove this availability?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            <% end %>
        <% end %>
        </div>
      </div>
    </div>
  </div>
  <div class="band-dashboard-content">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-comments"></i>
        </div>
        <h3>Band Chat</h3>
      </div>
      <div class="band-chat-wrapper">
        <%= render 'chat', band: @band %>
      </div>
    </div>

    <%# Musicians Wanted Section %>
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon card-icon-feed">
          <i class="fa-solid fa-bullhorn"></i>
        </div>
        <h3>Musicians Wanted</h3>
        <%= link_to posts_path, class: "band-feed-note" do %>
          <i class="fa-solid fa-plus"></i> Post New Request
        <% end %>
      </div>
      <div class="band-feed-section">
        <% wanted_posts = @band.posts.where(active: true).where('needed_by >= ?', Date.current).recent.limit(5) %>
        <% if wanted_posts.any? %>
          <div class="band-posts-feed">
            <% wanted_posts.each do |post| %>
              <%= render "posts/post", post: post %>
            <% end %>
          </div>
        <% else %>
          <div class="band-empty-feed">
            <i class="fa-solid fa-bullhorn"></i>
            <p>No active musician requests</p>
            <p class="sub">
              <%= link_to "Post a request", posts_path %> to find session musicians
            </p>
          </div>
        <% end %>
      </div>
    </div>
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-plus"></i>
        </div>
        <h3>Invite Musicians</h3>
      </div>
      <div class="band-invite-section">
        <turbo-frame id="band_invitation_form">
          <%= render partial: "bands/invite", locals: { band: @band, invitation: @band_invitation } %>
        </turbo-frame>
        <div class="mt-4">
          <%= render partial: "bands/pending_invitations", locals: { pending_invitations: @pending_invitations } %>
        </div>
      </div>
    </div>
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <h3>Band Members</h3>
      </div>
      <div class="band-members-list">
        <% @band.musicians.each do |musician| %>
          <div class="band-member-item">
            <%= link_to musician_path(musician), class: "member-avatar-link" do %>
              <div class="member-avatar">
                <% if musician.banner.attached? %>
                  <%= image_tag url_for(musician.banner), class: "avatar-image" %>
                <% elsif musician.images.attached? %>
                  <%= image_tag url_for(musician.images.first), class: "avatar-image" %>
                <% else %>
                  <i class="fa-solid fa-user"></i>
                <% end %>
              </div>
            <% end %>
            <div class="member-details">
              <div class="member-name">
                <%= link_to musician.name, musician_path(musician) %>
                <% if musician.user_id == @band.user_id %>
                  <span class="leader-badge"><i class="fa-solid fa-crown"></i> Leader</span>
                <% end %>
              </div>
              <div class="member-info">
                <span class="member-instrument"><i class="fa-solid fa-guitar"></i> <%= musician.instrument || "Not specified" %></span>
                <% if musician.location.present? %>
                  <span class="member-location"><i class="fa-solid fa-location-dot"></i> <%= musician.location %></span>
                <% end %>
              </div>
            </div>
            <div class="member-actions">
              <% if musician.user_id != current_user.id %>
                <%= button_to create_or_show_direct_messages_path(recipient_id: musician.user_id), method: :post, class: "btn-member-action", title: "Send Message" do %>
                  <i class="fa-solid fa-envelope"></i>
                <% end %>
              <% end %>
              <% if @band.user_id == current_user.id && musician.user_id != current_user.id %>
                <% involvement = Involvement.find_by(band: @band, musician: musician) %>
                <% if involvement %>
                  <%= button_to involvement_path(involvement), method: :delete, class: "btn-member-action danger", title: "Remove from Band", data: { turbo_confirm: "Remove #{musician.name} from #{@band.name}?" } do %>
                    <i class="fa-solid fa-user-minus"></i>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>



    <!-- Band Media Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-images"></i>
        </div>
        <h3>Band Media</h3>
      </div>
      <!-- Current Media Display (only shows sections with content) -->
      <% if @band.banner.attached? || @band.images.attached? || @band.videos.attached? %>
        <div class="current-media-section">
          <h4 class="current-media-title"><i class="fa-solid fa-photo-film"></i> Current Media</h4>
          <% if @band.banner.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Banner</label>
              <div class="current-media-preview banner-preview">
                <%= image_tag url_for(@band.banner), class: "banner-image-preview" %>
                <%= button_to purge_attachment_band_path(@band, attachment_id: @band.banner.id),
                    method: :delete,
                    class: "btn-remove-media",
                    data: { turbo_confirm: "Remove this banner image?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            </div>
            <!-- Banner Position Adjuster -->
            <div class="media-display-group" data-controller="banner-position">
              <label class="media-group-label">Banner Position</label>
              <p class="banner-position-help">Drag the image up or down to adjust what part is visible</p>
              <div class="banner-position-adjuster">
                <div class="banner-position-preview" data-banner-position-target="preview">
                  <%= image_tag url_for(@band.banner),
                      data: { banner_position_target: "image" },
                      style: "object-position: center #{@band.banner_position || 50}%;" %>
                </div>
                <div class="banner-position-controls">
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveUp" title="Move up">
                    <i class="fa-solid fa-chevron-up"></i>
                  </button>
                  <span class="position-value" data-banner-position-target="value"><%= @band.banner_position || 50 %>%</span>
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveDown" title="Move down">
                    <i class="fa-solid fa-chevron-down"></i>
                  </button>
                </div>
              </div>
              <%= form_with model: @band, local: true, class: "banner-position-form", data: { banner_position_target: "form" } do |f| %>
                <%= f.hidden_field :banner_position, data: { banner_position_target: "input" }, value: @band.banner_position || 50 %>
                <%= f.submit "Save Position", class: "btn-save-position" %>
              <% end %>
            </div>
          <% end %>
          <% if @band.images.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Photos (<%= @band.images.count %>)</label>
              <div class="current-media-grid">
                <% @band.images.each do |image| %>
                  <div class="media-grid-item">
                    <%= image_tag url_for(image), class: "preview-image" %>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: image.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this photo?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @band.videos.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Videos (<%= @band.videos.count %>)</label>
              <div class="current-media-grid videos-grid">
                <% @band.videos.each do |video| %>
                  <div class="media-grid-item video-item">
                    <video controls class="preview-video">
                      <source src="<%= url_for(video) %>" type="<%= video.content_type %>">
                    </video>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: video.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this video?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      <!-- Upload Form -->
      <%= form_with model: @band, local: true, class: "band-media-form", id: "band-media-form" do |f| %>
        <%# Hidden field for banner position - updated by Stimulus controller when position is adjusted %>
        <%= f.hidden_field :banner_position, id: "band-media-form-banner-position", value: @band.banner_position || 50 %>
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4>Upload Media</h4>
              <p>Add new banner, photos, or videos to your band profile</p>
            </div>
          </div>
          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Banner Image</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @band.banner.attached? ? "Replace banner" : "Choose banner" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Photos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :images, accept: "image/*", multiple: true, class: "media-file-input", id: "images-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="images-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-camera"></i>
                  <span>Add photos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Videos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :videos, accept: "video/*", multiple: true, class: "media-file-input", id: "videos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="videos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-video"></i>
                  <span>Add videos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
          <div class="media-submit-wrapper">
            <%= f.submit "Save Media", class: "btn-save-media" %>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Spotify Tracks Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-brands fa-spotify"></i>
        </div>
        <h3>Your Music</h3>
      </div>
      <div class="spotify-tracks-section">
        <p class="spotify-description">Paste Spotify links to tracks, albums, or playlists to feature on your profile.</p>
        <div id="spotify-tracks">
          <%= render partial: 'spotify_tracks/editable_track', collection: @band.spotify_tracks, as: :track %>
        </div>
        <%= render 'spotify_tracks/form', band: @band %>
      </div>
    </div>

    <!-- Social Media Tracking Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-chart-simple"></i>
        </div>
        <h3>Social Media Tracking</h3>
        <span class="band-feed-note">Track your growth across platforms</span>
      </div>
      <div class="social-tracking-section">
        <%= form_with model: @band, local: true, class: "social-tracking-form" do |f| %>
          <div class="social-stats-grid">
            <%# Instagram %>
            <div class="social-stat-card instagram">
              <div class="social-stat-header">
                <i class="fa-brands fa-instagram"></i>
                <span>Instagram</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :instagram_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :instagram_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.instagram_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.instagram_followers) %></span>
                </div>
              <% end %>
            </div>

            <%# TikTok %>
            <div class="social-stat-card tiktok">
              <div class="social-stat-header">
                <i class="fa-brands fa-tiktok"></i>
                <span>TikTok</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :tiktok_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :tiktok_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.tiktok_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.tiktok_followers) %></span>
                </div>
              <% end %>
            </div>

            <%# YouTube %>
            <div class="social-stat-card youtube">
              <div class="social-stat-header">
                <i class="fa-brands fa-youtube"></i>
                <span>YouTube</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :youtube_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :youtube_subscribers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">subscribers</span>
                </div>
              </div>
              <% if @band.youtube_subscribers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.youtube_subscribers) %></span>
                </div>
              <% end %>
            </div>

            <%# Twitter/X %>
            <div class="social-stat-card twitter">
              <div class="social-stat-header">
                <i class="fa-brands fa-x-twitter"></i>
                <span>X / Twitter</span>
              </div>
              <div class="social-stat-inputs">
                <%= f.text_field :twitter_handle, placeholder: "@yourband", class: "social-handle-input" %>
                <div class="social-followers-input">
                  <%= f.number_field :twitter_followers, placeholder: "0", min: 0, class: "social-count-input" %>
                  <span class="social-count-label">followers</span>
                </div>
              </div>
              <% if @band.twitter_followers.to_i > 0 %>
                <div class="social-stat-display">
                  <span class="social-stat-number"><%= number_with_delimiter(@band.twitter_followers) %></span>
                </div>
              <% end %>
            </div>
          </div>

          <div class="social-tracking-total">
            <% total_followers = (@band.instagram_followers.to_i + @band.tiktok_followers.to_i + @band.youtube_subscribers.to_i + @band.twitter_followers.to_i) %>
            <div class="total-reach">
              <span class="total-label">Total Reach</span>
              <span class="total-number"><%= number_with_delimiter(total_followers) %></span>
            </div>
          </div>

          <div class="social-tracking-submit">
            <%= f.submit "Save Social Stats", class: "btn-save-social" %>
          </div>
        <% end %>
      </div>
    </div>

    <% if @band.user_id == current_user.id %>
      <% other_members = @band.musicians.where.not(user_id: current_user.id) %>
      <% if other_members.any? %>
        <div class="band-dashboard-card full-width">
          <div class="band-card-header">
            <div class="card-icon">
              <i class="fa-solid fa-crown"></i>
            </div>
            <h3>Transfer Leadership</h3>
          </div>
          <div class="transfer-leadership-section">
            <p>Transfer band leadership to another member. You will remain a member of the band but will no longer be able to delete it or manage invitations.</p>
            <div class="transfer-form">
              <%= form_with url: transfer_leadership_band_path(@band), method: :patch, local: true do |f| %>
                <div class="transfer-input-group">
                  <div class="transfer-select-wrapper">
                    <%= f.label :musician_id, class: "transfer-label" do %>
                      <i class="fa-solid fa-user"></i> Select New Leader
                    <% end %>
                    <%= f.collection_select :musician_id, other_members, :id, :name,
                        { prompt: "Choose a band member..." },
                        { class: "transfer-select" } %>
                  </div>
                  <%= f.submit "Transfer Leadership", class: "btn-transfer",
                      data: { turbo_confirm: "Are you sure you want to transfer leadership? You will no longer be the band leader." } %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      <div class="band-dashboard-card full-width leave-band-card">
        <div class="band-card-header">
          <div class="card-icon danger">
            <i class="fa-solid fa-trash"></i>
          </div>
          <h3>Delete Band</h3>
        </div>
        <div class="leave-band-section">
          <p>As the band leader, you cannot leave the band. Deleting the band will remove all members, chat history, gig applications, and cannot be undone.</p>
          <%= button_to "Delete #{@band.name}", band_path(@band),
              method: :delete,
              class: "btn-leave-band",
              data: { turbo_confirm: "Are you sure you want to permanently delete #{@band.name}? All members will be removed and this cannot be undone." } %>
        </div>
      </div>
    <% elsif current_user.musician %>
      <% involvement = Involvement.find_by(band: @band, musician: current_user.musician) %>
      <% if involvement %>
        <div class="band-dashboard-card full-width leave-band-card">
          <div class="band-card-header">
            <div class="card-icon danger">
              <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h3>Leave Band</h3>
          </div>
          <div class="leave-band-section">
            <p>If you leave this band, you will no longer have access to the band chat or be able to apply for gigs with this band.</p>
            <%= button_to "Leave #{@band.name}", involvement_path(involvement),
                method: :delete,
                class: "btn-leave-band",
                data: { turbo_confirm: "Are you sure you want to leave #{@band.name}? This action cannot be undone." } %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
