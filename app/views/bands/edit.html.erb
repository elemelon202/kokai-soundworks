<div class="band-dashboard-container">
  <div class="band-dashboard-header">
    <h1>Band Dashboard</h1>
    <h2>Manage your band gig applications and members</h2>
    <%= link_to band_path(@band), class: "btn-view-band" do %>
      <i class="fa-solid fa-eye"></i> View Band Page
    <% end %>
  </div>

  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } %>
  </div>

  <div class="band-stats-grid">
    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-ticket"></i>
      </div>
      <div class="stat-value"><%= @band.bookings.count %></div>
      <div class="stat-label">Gig Applications</div>
      <div class="stat-sub">Pending: <%= @pending_bookings.count %></div>
    </div>

    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @band.musicians.count %></div>
      <div class="stat-label">Band Members</div>
    </div>

    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-calendar-days"></i>
      </div>
      <div class="stat-value"><%= @band.gigs.count %></div>
      <div class="stat-label">Upcoming Gigs</div>
    </div>

    <div class="band-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-envelope"></i>
      </div>
      <div class="stat-value"><%= @unread_count %></div>
      <div class="stat-label">Unread Messages</div>
    </div>
  </div>

  <div class="band-dashboard-content">
    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-comments"></i>
        </div>
        <h3>Band Chat</h3>
      </div>
      <div class="band-chat-wrapper">
        <%= render 'chat', band: @band %>
      </div>
    </div>

    <div class="band-dashboard-card">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-user-plus"></i>
        </div>
        <h3>Invite Musicians</h3>
      </div>
      <div class="band-invite-section">
        <turbo-frame id="band_invitation_form">
          <%= render partial: "bands/invite", locals: { band: @band, invitation: @band_invitation } %>
        </turbo-frame>

        <div class="mt-4">
          <%= render partial: "bands/pending_invitations", locals: { pending_invitations: @pending_invitations } %>
        </div>
      </div>
    </div>

    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <h3>Band Members</h3>
      </div>
      <div class="band-members-list">
        <% @band.musicians.each do |musician| %>
          <div class="band-member-item">
            <%= link_to musician_path(musician), class: "member-avatar-link" do %>
              <div class="member-avatar">
                <% if musician.banner.attached? %>
                  <%= image_tag url_for(musician.banner), class: "avatar-image" %>
                <% elsif musician.images.attached? %>
                  <%= image_tag url_for(musician.images.first), class: "avatar-image" %>
                <% else %>
                  <i class="fa-solid fa-user"></i>
                <% end %>
              </div>
            <% end %>
            <div class="member-details">
              <div class="member-name">
                <%= link_to musician.name, musician_path(musician) %>
                <% if musician.user_id == @band.user_id %>
                  <span class="leader-badge"><i class="fa-solid fa-crown"></i> Leader</span>
                <% end %>
              </div>
              <div class="member-info">
                <span class="member-instrument"><i class="fa-solid fa-guitar"></i> <%= musician.instrument || "Not specified" %></span>
                <% if musician.location.present? %>
                  <span class="member-location"><i class="fa-solid fa-location-dot"></i> <%= musician.location %></span>
                <% end %>
              </div>
            </div>
            <div class="member-actions">
              <% if musician.user_id != current_user.id %>
                <%= button_to create_or_show_direct_messages_path(recipient_id: musician.user_id), method: :post, class: "btn-member-action", title: "Send Message" do %>
                  <i class="fa-solid fa-envelope"></i>
                <% end %>
              <% end %>
              <% if @band.user_id == current_user.id && musician.user_id != current_user.id %>
                <% involvement = Involvement.find_by(band: @band, musician: musician) %>
                <% if involvement %>
                  <%= button_to involvement_path(involvement), method: :delete, class: "btn-member-action danger", title: "Remove from Band", data: { turbo_confirm: "Remove #{musician.name} from #{@band.name}?" } do %>
                    <i class="fa-solid fa-user-minus"></i>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-clipboard-list"></i>
        </div>
        <h3>Gig Applications</h3>
      </div>

      <% if @pending_bookings.any? %>
        <% @pending_bookings.each do |booking| %>
          <div class="gig-application-card">
            <h5><%= booking.gig.name %></h5>
            <p><strong>Date:</strong> <%= booking.gig.date.strftime("%B %d, %Y") %></p>
            <p><strong>Venue:</strong> <%= booking.gig.venue.name %></p>
            <span class="status-badge <%= booking.status.downcase %>"><%= booking.status %></span>
          </div>
        <% end %>
      <% else %>
        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 30px;">No pending gig applications</p>
      <% end %>
    </div>

    <!-- Band Media Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-images"></i>
        </div>
        <h3>Band Media</h3>
      </div>

      <!-- Current Media Display (only shows sections with content) -->
      <% if @band.banner.attached? || @band.images.attached? || @band.videos.attached? %>
        <div class="current-media-section">
          <h4 class="current-media-title"><i class="fa-solid fa-photo-film"></i> Current Media</h4>

          <% if @band.banner.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Banner</label>
              <div class="current-media-preview banner-preview">
                <%= image_tag url_for(@band.banner), class: "banner-image-preview" %>
                <%= button_to purge_attachment_band_path(@band, attachment_id: @band.banner.id),
                    method: :delete,
                    class: "btn-remove-media",
                    data: { turbo_confirm: "Remove this banner image?" } do %>
                  <i class="fa-solid fa-trash"></i>
                <% end %>
              </div>
            </div>

            <!-- Banner Position Adjuster -->
            <div class="media-display-group" data-controller="banner-position">
              <label class="media-group-label">Banner Position</label>
              <p class="banner-position-help">Drag the image up or down to adjust what part is visible</p>
              <div class="banner-position-adjuster">
                <div class="banner-position-preview" data-banner-position-target="preview">
                  <%= image_tag url_for(@band.banner),
                      data: { banner_position_target: "image" },
                      style: "object-position: center #{@band.banner_position || 50}%;" %>
                </div>
                <div class="banner-position-controls">
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveUp" title="Move up">
                    <i class="fa-solid fa-chevron-up"></i>
                  </button>
                  <span class="position-value" data-banner-position-target="value"><%= @band.banner_position || 50 %>%</span>
                  <button type="button" class="btn-position-adjust" data-action="click->banner-position#moveDown" title="Move down">
                    <i class="fa-solid fa-chevron-down"></i>
                  </button>
                </div>
              </div>
              <%= form_with model: @band, local: true, class: "banner-position-form", data: { banner_position_target: "form" } do |f| %>
                <%= f.hidden_field :banner_position, data: { banner_position_target: "input" }, value: @band.banner_position || 50 %>
                <%= f.submit "Save Position", class: "btn-save-position" %>
              <% end %>
            </div>
          <% end %>

          <% if @band.images.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Photos (<%= @band.images.count %>)</label>
              <div class="current-media-grid">
                <% @band.images.each do |image| %>
                  <div class="media-grid-item">
                    <%= image_tag url_for(image), class: "preview-image" %>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: image.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this photo?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @band.videos.attached? %>
            <div class="media-display-group">
              <label class="media-group-label">Videos (<%= @band.videos.count %>)</label>
              <div class="current-media-grid videos-grid">
                <% @band.videos.each do |video| %>
                  <div class="media-grid-item video-item">
                    <video controls class="preview-video">
                      <source src="<%= url_for(video) %>" type="<%= video.content_type %>">
                    </video>
                    <%= button_to purge_attachment_band_path(@band, attachment_id: video.id),
                        method: :delete,
                        class: "btn-remove-media",
                        data: { turbo_confirm: "Remove this video?" } do %>
                      <i class="fa-solid fa-trash"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Upload Form -->
      <%= form_with model: @band, local: true, class: "band-media-form", id: "band-media-form" do |f| %>
        <%# Hidden field for banner position - updated by Stimulus controller when position is adjusted %>
        <%= f.hidden_field :banner_position, id: "band-media-form-banner-position", value: @band.banner_position || 50 %>
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4>Upload Media</h4>
              <p>Add new banner, photos, or videos to your band profile</p>
            </div>
          </div>

          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Banner Image</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :banner, accept: "image/*", class: "media-file-input", id: "banner-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="banner-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-panorama"></i>
                  <span><%= @band.banner.attached? ? "Replace banner" : "Choose banner" %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Photos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :images, accept: "image/*", multiple: true, class: "media-file-input", id: "images-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="images-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-camera"></i>
                  <span>Add photos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>

            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label">Videos</label>
              <div class="upload-input-wrapper">
                <%= f.file_field :videos, accept: "video/*", multiple: true, class: "media-file-input", id: "videos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="videos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-video"></i>
                  <span>Add videos</span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>

          <div class="media-submit-wrapper">
            <%= f.submit "Save Media", class: "btn-save-media" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Spotify Tracks Section -->
    <div class="band-dashboard-card full-width">
      <div class="band-card-header">
        <div class="card-icon">
          <i class="fa-brands fa-spotify"></i>
        </div>
        <h3>Your Music</h3>
      </div>
      <div class="spotify-tracks-section">
        <p class="spotify-description">Paste Spotify links to tracks, albums, or playlists to feature on your profile.</p>

        <div id="spotify-tracks">
          <%= render partial: 'spotify_tracks/editable_track', collection: @band.spotify_tracks, as: :track %>
        </div>

        <%= render 'spotify_tracks/form', band: @band %>
      </div>
    </div>

    <% if @band.user_id == current_user.id %>
      <% other_members = @band.musicians.where.not(user_id: current_user.id) %>
      <% if other_members.any? %>
        <div class="band-dashboard-card full-width">
          <div class="band-card-header">
            <div class="card-icon">
              <i class="fa-solid fa-crown"></i>
            </div>
            <h3>Transfer Leadership</h3>
          </div>
          <div class="transfer-leadership-section">
            <p>Transfer band leadership to another member. You will remain a member of the band but will no longer be able to delete it or manage invitations.</p>
            <div class="transfer-form">
              <%= form_with url: transfer_leadership_band_path(@band), method: :patch, local: true do |f| %>
                <div class="transfer-input-group">
                  <div class="transfer-select-wrapper">
                    <%= f.label :musician_id, class: "transfer-label" do %>
                      <i class="fa-solid fa-user"></i> Select New Leader
                    <% end %>
                    <%= f.collection_select :musician_id, other_members, :id, :name,
                        { prompt: "Choose a band member..." },
                        { class: "transfer-select" } %>
                  </div>
                  <%= f.submit "Transfer Leadership", class: "btn-transfer",
                      data: { turbo_confirm: "Are you sure you want to transfer leadership? You will no longer be the band leader." } %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <div class="band-dashboard-card full-width leave-band-card">
        <div class="band-card-header">
          <div class="card-icon danger">
            <i class="fa-solid fa-trash"></i>
          </div>
          <h3>Delete Band</h3>
        </div>
        <div class="leave-band-section">
          <p>As the band leader, you cannot leave the band. Deleting the band will remove all members, chat history, gig applications, and cannot be undone.</p>
          <%= button_to "Delete #{@band.name}", band_path(@band),
              method: :delete,
              class: "btn-leave-band",
              data: { turbo_confirm: "Are you sure you want to permanently delete #{@band.name}? All members will be removed and this cannot be undone." } %>
        </div>
      </div>
    <% elsif current_user.musician %>
      <% involvement = Involvement.find_by(band: @band, musician: current_user.musician) %>
      <% if involvement %>
        <div class="band-dashboard-card full-width leave-band-card">
          <div class="band-card-header">
            <div class="card-icon danger">
              <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h3>Leave Band</h3>
          </div>
          <div class="leave-band-section">
            <p>If you leave this band, you will no longer have access to the band chat or be able to apply for gigs with this band.</p>
            <%= button_to "Leave #{@band.name}", involvement_path(involvement),
                method: :delete,
                class: "btn-leave-band",
                data: { turbo_confirm: "Are you sure you want to leave #{@band.name}? This action cannot be undone." } %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
