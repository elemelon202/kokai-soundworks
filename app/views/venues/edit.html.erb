<div class="musician-dashboard-container">
  <div class="musician-dashboard-header">
    <h1><%= t('venues.edit.title') %></h1>
    <h2><%= t('venues.edit.subtitle') %></h2>
    <%= link_to venue_path(@venue), class: "btn-view-profile" do %>
      <i class="fa-solid fa-eye"></i> <%= t('venues.edit.view_venue') %>
    <% end %>
  </div>

  <div id="flash_messages">
    <%= render partial: "shared/flash", locals: { notice: flash[:notice], alert: flash[:alert] } if defined?(flash) %>
  </div>

  <div class="musician-stats-grid">
    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-calendar"></i>
      </div>
      <div class="stat-value"><%= @venue.gigs.where('date >= ?', Date.current).count %></div>
      <div class="stat-label"><%= t('venues.edit.upcoming_gigs') %></div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-clipboard-list"></i>
      </div>
      <div class="stat-value"><%= @venue.gigs.joins(:gig_applications).where(gig_applications: { status: :pending }).distinct.count %></div>
      <div class="stat-label"><%= t('venues.edit.pending_apps') %></div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-users"></i>
      </div>
      <div class="stat-value"><%= @venue.capacity || "—" %></div>
      <div class="stat-label"><%= t('venues.edit.capacity') %></div>
    </div>

    <div class="musician-stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-location-dot"></i>
      </div>
      <div class="stat-value"><%= @venue.city || "—" %></div>
      <div class="stat-label"><%= t('venues.edit.city') %></div>
    </div>
  </div>

  <%# Stripe Connect Section %>
  <div class="musician-dashboard-card">
    <div class="musician-card-header">
      <div class="card-icon">
        <i class="fa-brands fa-stripe"></i>
      </div>
      <h3><%= t('venues.edit.stripe_connect') %></h3>
    </div>
    <div class="dashboard-card-padding">
      <% if @venue.stripe_connected? %>
        <div class="stripe-status connected">
          <i class="fa-solid fa-check-circle"></i>
          <div>
            <p class="status-title"><%= t('venues.edit.stripe_connected') %></p>
            <p class="status-subtitle"><%= t('venues.edit.stripe_connected_desc') %></p>
          </div>
        </div>
        <% if @venue.venue_stripe_account.charges_enabled? %>
          <div class="stripe-features">
            <span class="feature-badge success"><i class="fa-solid fa-credit-card"></i> <%= t('venues.edit.charges_enabled') %></span>
            <% if @venue.venue_stripe_account.payouts_enabled? %>
              <span class="feature-badge success"><i class="fa-solid fa-money-bill-transfer"></i> <%= t('venues.edit.payouts_enabled') %></span>
            <% end %>
          </div>
        <% else %>
          <div class="stripe-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <p><%= t('venues.edit.complete_stripe_setup') %></p>
          </div>
          <%= link_to new_venue_stripe_account_path(@venue), class: "btn-stripe-connect" do %>
            <i class="fa-solid fa-arrow-right"></i> <%= t('venues.edit.complete_setup') %>
          <% end %>
        <% end %>
      <% else %>
        <div class="stripe-status not-connected">
          <i class="fa-solid fa-credit-card"></i>
          <div>
            <p class="status-title"><%= t('venues.edit.connect_stripe') %></p>
            <p class="status-subtitle"><%= t('venues.edit.connect_stripe_desc') %></p>
          </div>
        </div>
        <%= link_to new_venue_stripe_account_path(@venue), class: "btn-stripe-connect" do %>
          <i class="fa-brands fa-stripe"></i> <%= t('venues.edit.connect_with_stripe') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Active Funded Gigs Section %>
  <% active_funded_gigs = @venue.gigs.joins(:funded_gig).where(funded_gigs: { funding_status: [:open_for_applications, :accepting_pledges] }).includes(:funded_gig) %>
  <% if active_funded_gigs.any? %>
    <div class="musician-dashboard-card">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-hand-holding-dollar"></i>
        </div>
        <h3><%= t('venues.edit.active_funded_gigs') %></h3>
      </div>
      <div class="dashboard-card-padding">
        <div class="funded-gigs-list">
          <% active_funded_gigs.each do |gig| %>
            <div class="funded-gig-card">
              <div class="funded-gig-info">
                <h4><%= link_to gig.name, funded_gig_path(gig.funded_gig) %></h4>
                <p class="gig-date"><%= gig.date.strftime("%b %d, %Y") %></p>
                <div class="funding-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: <%= gig.funded_gig.funding_percentage %>%"></div>
                  </div>
                  <span class="progress-text"><%= number_to_currency(gig.funded_gig.current_pledged_cents / 100.0, unit: "¥", precision: 0) %> / <%= number_to_currency(gig.funded_gig.funding_target_cents / 100.0, unit: "¥", precision: 0) %></span>
                </div>
              </div>
              <span class="status-badge <%= gig.funded_gig.funding_status %>"><%= gig.funded_gig.funding_status.titleize %></span>
            </div>
          <% end %>
        </div>
        <%= link_to funded_gigs_path, class: "link-view-apps" do %>
          <%= t('venues.edit.view_all_funded_gigs') %> <i class="fa-solid fa-arrow-right"></i>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Create New Gig and Pending Applications Row %>
  <div class="dashboard-feed-analytics-row">
    <%# New Gig Form - Left %>
    <div class="musician-dashboard-card">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-plus"></i>
        </div>
        <h3><%= t('venues.edit.create_new_gig') %></h3>
      </div>
      <div class="dashboard-card-padding">
        <%= simple_form_for [@venue, @gig], html: { class: "venue-gig-form" } do |f| %>
          <div class="form-field">
            <%= f.input :name, label: false, placeholder: t('venues.edit.gig_name'), input_html: { class: "form-input venue-form-input" } %>
          </div>

          <%# Interactive Calendar %>
          <div class="venue-gig-form-row">
            <div class="venue-gig-form-col" data-controller="datepicker">
              <label class="venue-form-label">
                <i class="fa-solid fa-calendar"></i> <%= t('venues.edit.select_date') %>
              </label>
              <input type="hidden" name="gig[date]" data-datepicker-target="input">
              <div class="calendar-wrapper"></div>
            </div>
            <div class="venue-gig-form-col-sm">
              <div>
                <label class="venue-form-label">
                  <i class="fa-solid fa-clock"></i> <%= t('venues.edit.start_time') %>
                </label>
                <%= f.input :start_time, as: :time, label: false, input_html: { type: "time", class: "form-input venue-form-input" } %>
              </div>
              <div>
                <label class="venue-form-label">
                  <i class="fa-solid fa-clock"></i> <%= t('venues.edit.end_time') %>
                </label>
                <%= f.input :end_time, as: :time, label: false, input_html: { type: "time", class: "form-input venue-form-input" } %>
              </div>
            </div>
          </div>

          <%= f.submit t('venues.edit.create_gig'), class: "btn-save-profile" %>
        <% end %>
      </div>
    </div>

    <%# Pending Applications - Right %>
    <div class="musician-dashboard-card">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-inbox"></i>
        </div>
        <h3><%= t('venues.edit.pending_applications') %></h3>
      </div>
      <div class="dashboard-card-padding">
        <% pending_apps = GigApplication.joins(gig: :venue).where(venues: { id: @venue.id }, status: :pending).includes(:band, :gig).limit(5) %>
        <% if pending_apps.any? %>
          <div class="pending-apps-list">
            <% pending_apps.each do |app| %>
              <div class="pending-app-card">
                <div>
                  <p class="app-band-name"><%= app.band.name %></p>
                  <p class="app-gig-info"><%= app.gig.name %> &bull; <%= app.gig.date.strftime("%b %d") %></p>
                </div>
                <div class="pending-app-actions">
                  <%= button_to approve_gig_application_path(app), method: :patch, class: "btn-app-approve" do %>
                    <i class="fa-solid fa-check"></i>
                  <% end %>
                  <%= button_to reject_gig_application_path(app), method: :patch, class: "btn-app-reject" do %>
                    <i class="fa-solid fa-xmark"></i>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <%= link_to gig_applications_path, class: "link-view-apps" do %>
            <%= t('venues.edit.view_all_applications') %> <i class="fa-solid fa-arrow-right"></i>
          <% end %>
        <% else %>
          <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <p><%= t('venues.edit.no_pending_applications') %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Upcoming Gigs Section %>
  <% upcoming_gigs = @venue.gigs.where('date >= ?', Date.current).order(:date) %>
  <div class="musician-dashboard-card">
    <div class="musician-card-header">
      <div class="card-icon">
        <i class="fa-solid fa-calendar-days"></i>
      </div>
      <h3><%= t('venues.edit.upcoming_gigs') %></h3>
    </div>
    <div class="dashboard-card-padding">
      <% if upcoming_gigs.any? %>
        <div class="gigs-list">
          <% upcoming_gigs.each do |gig| %>
            <div class="venue-edit-gig-card">
              <div class="venue-edit-gig-content">
                <div class="venue-edit-gig-info">
                  <h4>
                    <%= link_to gig.name, gig_path(gig) %>
                  </h4>
                  <p class="gig-datetime">
                    <i class="fa-solid fa-clock"></i>
                    <%= gig.date.strftime("%A, %B %d, %Y") %>
                    <% if gig.start_time.present? %>
                      at <%= gig.start_time.strftime("%l:%M %p") %>
                    <% end %>
                  </p>
                  <% if gig.bands.any? %>
                    <div class="gig-bands-list">
                      <% gig.bands.each do |band| %>
                        <%= link_to band_path(band), class: "band-tag" do %>
                          <i class="fa-solid fa-users"></i>
                          <%= band.name %>
                        <% end %>
                      <% end %>
                    </div>
                  <% else %>
                    <p class="no-bands-notice">
                      <i class="fa-solid fa-info-circle"></i> <%= t('venues.edit.no_bands_booked') %>
                    </p>
                  <% end %>
                </div>
                <div class="venue-edit-gig-actions">
                  <% pending_count = gig.gig_applications.pending.count %>
                  <% if pending_count > 0 %>
                    <span class="pending-badge"><%= pending_count %> <%= t('venues.edit.pending') %></span>
                  <% end %>
                  <%= link_to edit_gig_path(gig), class: "btn-gig-edit" do %>
                    <i class="fa-solid fa-pen"></i> <%= t('common.edit') %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state large">
          <i class="fa-solid fa-calendar-xmark"></i>
          <p><%= t('venues.edit.no_upcoming_gigs') %></p>
          <p class="sub"><%= t('venues.edit.create_gig_hint') %></p>
        </div>
      <% end %>
    </div>
  </div>

  <%# Edit Venue Details %>
  <div class="musician-dashboard-content">
    <div class="musician-dashboard-card full-width">
      <div class="musician-card-header">
        <div class="card-icon">
          <i class="fa-solid fa-building"></i>
        </div>
        <h3><%= t('venues.edit.edit_venue_details') %></h3>
      </div>

      <%= simple_form_for @venue, html: { class: "musician-edit-form" } do |f| %>
        <% if @venue.errors.any? %>
          <div class="error-box">
            <ul>
              <% @venue.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-signature"></i> <%= t('venues.edit.venue_name') %>
            </label>
            <%= f.text_field :name, class: "form-input", placeholder: t('venues.edit.venue_name') %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-city"></i> <%= t('venues.edit.city') %>
            </label>
            <%= f.text_field :city, class: "form-input", placeholder: t('venues.edit.city') %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-location-dot"></i> <%= t('venues.edit.address') %>
            </label>
            <%= f.text_field :address, class: "form-input", placeholder: t('venues.edit.address') %>
          </div>

          <div class="form-field">
            <label class="form-label">
              <i class="fa-solid fa-users"></i> <%= t('venues.edit.capacity') %>
            </label>
            <%= f.number_field :capacity, class: "form-input", placeholder: t('venues.edit.capacity') %>
          </div>

          <div class="form-field full-width">
            <label class="form-label">
              <i class="fa-solid fa-pen"></i> <%= t('venues.edit.description') %>
            </label>
            <%= f.text_area :description, class: "form-input", placeholder: t('venues.edit.description'), rows: 4 %>
          </div>
        </div>

        <%# Media Upload Section %>
        <div class="media-upload-section">
          <div class="media-section-header">
            <i class="fa-solid fa-cloud-upload-alt"></i>
            <div>
              <h4><%= t('venues.edit.venue_photos') %></h4>
              <p><%= t('venues.edit.add_photos') %></p>
            </div>
          </div>

          <div class="upload-fields-grid">
            <div class="upload-field" data-controller="file-preview">
              <label class="upload-field-label"><%= t('venues.edit.photos') %></label>
              <div class="upload-input-wrapper">
                <%= f.file_field :photos, multiple: true, accept: "image/*", class: "media-file-input", id: "venue-photos-input",
                    data: { file_preview_target: "input", action: "change->file-preview#preview" } %>
                <label for="venue-photos-input" class="upload-label compact" data-file-preview-target="placeholder">
                  <i class="fa-solid fa-images"></i>
                  <span><%= @venue.photos.attached? ? t('venues.edit.add_more_photos') : t('venues.edit.choose_photos') %></span>
                </label>
              </div>
              <div class="file-preview-container" data-file-preview-target="preview"></div>
            </div>
          </div>
        </div>

        <%# Current Photos %>
        <% if @venue.photos.attached? %>
          <div class="venue-current-photos">
            <h4><%= t('venues.edit.current_photos') %></h4>
            <div class="venue-photos-grid">
              <% @venue.photos.each do |photo| %>
                <div class="venue-photo-thumb">
                  <%= cl_image_tag photo.key %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="form-submit-wrapper">
          <%= f.submit t('venues.edit.save_changes'), class: "btn-save-profile" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
