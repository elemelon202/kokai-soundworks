<div class="dm-sidebar">
  <div class="sidebar-header">
    <h3>Messages</h3>
    <button type="button" class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#newChatModal">
      + New
    </button>
  </div>

  <div class="conversations-list">
    <% @chats.each do |chat| %>
      <% other_user = chat.other_participant(current_user) %>
      <% next unless other_user %>
      <div class="conversation-item <%= 'active' if @chat&.id == chat.id %>">
        <%= link_to direct_message_path(chat), class: "conversation-link" do %>
          <div class="conversation-info">
            <strong><%= other_user.username %></strong>
            <% if other_user.musician %>
              <span class="badge bg-secondary"><%= other_user.musician.instrument %></span>
            <% end %>
            <% last_message = chat.messages.last %>
            <% if last_message %>
              <p class="last-message"><%= truncate(last_message.content, length: 30) %></p>
            <% end %>
          </div>
          <div class="conversation-meta">
            <% unread = chat.unread_count_for(current_user) %>
            <% if unread > 0 %>
              <span class="unread-badge"><%= unread %></span>
            <% end %>
          </div>
        <% end %>
        <%= button_to direct_message_path(chat), method: :delete, class: "delete-chat-btn", data: { turbo_confirm: "Delete this conversation?" } do %>
          <span>&times;</span>
        <% end %>
      </div>
    <% end %>

    <% if @chats.empty? %>
      <p class="no-chats">No conversations yet</p>
    <% end %>
  </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newChatModalLabel">Start a New Conversation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="musician-search-container">
          <div class="musician-search-wrapper">
            <i class="fa-solid fa-search"></i>
            <input type="text" id="musicianSearch" class="musician-search-input" placeholder="Search musicians by name...">
          </div>
        </div>
        <p class="search-hint">Select a musician to message:</p>
        <div class="musician-list" id="musicianList">
          <% @musicians.each do |musician| %>
            <% next if musician.user_id == current_user.id %>
            <%= link_to create_or_show_direct_messages_path(recipient_id: musician.user_id), method: :post, class: "musician-option", data: { turbo_method: :post, musician_name: musician.name.downcase, musician_instrument: musician.instrument&.downcase } do %>
              <div class="musician-info">
                <strong><%= musician.name %></strong>
                <span class="text-muted"><%= musician.instrument %></span>
              </div>
              <% if musician.location.present? %>
                <small class="text-muted"><%= musician.location %></small>
              <% end %>
            <% end %>
          <% end %>
        </div>
        <div class="no-results-message" id="noResultsMessage" style="display: none;">
          <i class="fa-solid fa-user-slash"></i>
          <p>No musicians found matching your search</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    setupMusicianSearch();
  });

  document.addEventListener("turbo:load", function() {
    setupMusicianSearch();
  });

  function setupMusicianSearch() {
    const searchInput = document.getElementById("musicianSearch");
    const musicianList = document.getElementById("musicianList");
    const noResultsMessage = document.getElementById("noResultsMessage");

    if (!searchInput || !musicianList) return;

    searchInput.addEventListener("input", function() {
      const searchTerm = this.value.toLowerCase().trim();
      const musicians = musicianList.querySelectorAll(".musician-option");
      let visibleCount = 0;

      musicians.forEach(function(musician) {
        const name = musician.dataset.musicianName || "";
        const instrument = musician.dataset.musicianInstrument || "";

        if (name.includes(searchTerm) || instrument.includes(searchTerm)) {
          musician.style.display = "block";
          visibleCount++;
        } else {
          musician.style.display = "none";
        }
      });

      if (noResultsMessage) {
        noResultsMessage.style.display = visibleCount === 0 ? "block" : "none";
      }
    });

    // Clear search when modal is opened
    const modal = document.getElementById("newChatModal");
    if (modal) {
      modal.addEventListener("shown.bs.modal", function() {
        searchInput.value = "";
        searchInput.dispatchEvent(new Event("input"));
        searchInput.focus();
      });
    }
  }
</script>
