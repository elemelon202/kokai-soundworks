<%= turbo_stream_from "chat_#{@chat.id}_user_#{current_user.id}" %>

<div class="chat-area">
  <div class="chat-header">
    <% other_user = @chat.other_participant(current_user) %>
    <h4 class="chat-participant-name">
      <%= other_user&.username || "Unknown User" %>
      <% if other_user&.musician %>
        <span class="badge bg-dark"><%= other_user.musician.instrument %></span>
      <% end %>
    </h4>
  </div>

  <div id="messages" class="messages-list" data-chat-id="<%= @chat.id %>" data-current-user-id="<%= current_user.id %>">
    <% @messages.each do |message| %>
      <%= render partial: "messages/message", locals: { message: message, current_user: current_user } %>
    <% end %>
  </div>

  <%= render partial: "messages/form", locals: { chat: @chat, message: @message } %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const messagesList = document.getElementById("messages");
    if (messagesList) {
      messagesList.scrollTop = messagesList.scrollHeight;
    }
  });

  document.addEventListener("turbo:before-stream-render", function(event) {
    setTimeout(() => {
      const messagesList = document.getElementById("messages");
      if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
      }
    }, 100);
  });
</script>
